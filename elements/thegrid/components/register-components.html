<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/elements/thegrid/grid-styles.html">

<dom-module id="register-components">
  <template>
    <style include="grid iron-flex">

      :host {
        display: block;
      }

      .logo-container {
        width: 200px;
        height: 48px;
        margin: 20px auto;
        background: transparent;
      }

      [data-step] {
        padding-top: 12px;
        padding-bottom: 12px;
        transition-property: all;
  			transform-style: cubic-bezier(0.4, 0, 0.2, 1);
  			transition-duration: 500ms;
      }

      .wr {
          overflow-x: hidden;
          /*height: 400px;*/
      }

      #formCarousel {
        height: 400px;
        overflow: hidden;
      }

      .input-action {
        color: #FF3B30;
        cursor: pointer;
        user-select: none;
        padding: 0 8px;
      }

    </style>

    <div class="p-y-1">

      <div class="header-text-container">
        <h1 class="header-text m-0">
          <span hidden$="[[step.message]]">[[step.question]]</span>
          <span hidden$="[[!step.message]]">[[step.message]]</span>
        </h1>
      </div>
      <div id="wr" class="wr">
        <form class="form" id="formCarousel">

          <div class="form-group relative"
              data-step="1"
              data-question="What is your name?">
            <input id="name" type="text" class="form-input" autofocus
                placeholder="Full Name"
                value="{{name::input}}"
                data-validate="required"
                data-message-required="Your name is required." />
          </div>

          <div class="input-group suffix" data-step="2" data-question="Hello %name. Your Email?">
            <input id="email" type="text" class="input"
                placeholder="Email"
                value="{{email::input}}"
                data-validate="required|email"
                data-message-required="Your email is required."
                data-message-email="Your email is invalid." />
            <div class="addon-suffix flex layout horizontal">
                <span class="input-action" on-click="gmail">Gmail</span>
                <span class="input-action" on-click="outlook">Outlook</span>
                <span class="input-action" on-click="icloud">iCloud</span>
            </div>
          </div>

          <div class="input-group prefix" data-step="3" data-question="Phone Number">
            <div class="addon-prefix flex layout horizontal">
              <span>AE +971</span>
            </div>
            <input id="phone_number" type="text" class="input"
                placeholder="Phone Number"
                value="{{phone_number::input}}"
                data-validate="required|number"
                data-message-required="Your phone number is required."
                data-message-number="Your phone number is invalid." />
          </div>

          <div class="input-group suffix" data-step="4" data-question="Create Password. A strong one.">
            <input id="password" type="password" class="input"
                placeholder="Password"
                value="{{password::input}}"
                data-validate="required"
                data-message-required="Your password is required." />
            <div class="addon-suffix">
                <span id="passwordToggler" class="input-action" on-click="tooglePassword">[[togglePasswordText]]</span>
            </div>
          </div>

          <div class="input-group" data-step="5" data-question="One more time!">
            <input id="password_confirmation" type="password" class="form-input"
                placeholder="Retype Password"
                value="{{password_confirmation::input}}"
                data-validate="required|match"
                data-match-to$="[[password]]"
                data-message-required="Please confirm your password."
                data-message-match="Password did not match." />
          </div>

          <div class="input-group" data-step="6" data-question="Pick your Username.">
            <input id="username" type="text" class="input"
                placeholder="User name"
                value="{{username::input}}"
                data-validate="required"
                data-message-required="Username is required." />
          </div>

          <!-- <div class="form-group">
            <paper-button class="w-100 white" on-click="signUp">
              <span hidden$="[[isSigningUp]]">Sign Up</span>
              <span hidden$="[[!isSigningUp]]">Loading...</span>
            </paper-button>
          </div> -->

        </form>
      </div>
    </div>
  </template>

  <script>

    class RegisterComponents extends ReduxBehavior(Polymer.Element) {

      static get is() { return 'register-components'; }

      static get properties() {
        return {

          togglePasswordText: {
            type: String,
            value: 'Show'
          },

          isPasswordHidden: {
            type: Boolean,
            value: true
          },

          step: {
            type: Object,
            value: {
              no: 1,
              question: 'What is your name?',
              message: null
            }
          },

          isSigningUp: {
            type: Boolean,
            value: false
          },

          isRegistered: {
            type: Boolean,
            value: false,
            notify: true
          },

          signUpData: {
            type: Object,
            value: {
              message: null
            },
            notify: true
          },

          hasErrorRegister: {
            type: Boolean,
            value: false,
            notify: true
          },

          currentStep: {
            type: Number,
            value: 1,
            notify: true
          },

          totalSteps: {
            type: Number,
            notify: true
          },

          next: {
            type: Boolean,
            value: false,
            notify: true
          },

          submiting: {
            type: Boolean,
            notify: true
          }
        }
      }

      static get observers() {
        return [
          '_passwordState(isPasswordHidden)',
          '_submitingChange(submiting)'
        ];
      }

      static get actions() {
  			return {
  				login(user) {
  					return {
  						type: 'LOGGED_USER',
  						user: user
  					}
  				}
  			};
  		}

      constructor() {
        super();
        this.fc = null;
        this.wr = null;
      }

      connectedCallback() {
        super.connectedCallback();

        this.fc = this.$.formCarousel;
        this.wr = this.$.wr;

        this.activeStep = 1;
        const h = this.fc.offsetHeight;

        this.stepHeight = 68;

        // this.fc.style.paddingBottom = this.stepHeight*3 + 'px';
        this.fc.style.paddingTop = this.stepHeight + 'px';
        this.steps = this.fc.querySelectorAll('[data-step]');

        this.passwordToggler = this.$.passwordToggler;
        this.currentScroll = 0;
        this.currentStep = 1;
        this.startY = 0;
        this._startY = 0;
        this.endY = 0;
        this.totalSteps = this.steps.length;

        this.arrangeSteps(this.currentStep);
        this.inputListenEvents();
        this.touchScrollEvents();

      }

      signUp() {
        const self = this;
        self.isSigningUp = true;
        axios.post(API_URL + '/users/register', {

          name: self.name,
          username: self.username,
          email: self.email,
          password: self.password,
          password_confirmation: self.password_confirmation,
          phone_number: self.phone_number

        }).then( res => {

          self.set('signUpData', res.data);
          self.isSigningUp = false;
          self.isRegistered = true;
          self.set('step.message', 'Successfully Registered!');
          self.fc.reset();
          self.submiting = false;

        }).catch( err => {

          if( err.response ) {
            self.set('signUpData', err.response.data);
            // self.hasErrorRegister = true;
            var errs = [];
            var fkey = null;
			    	for( var key in this.signUpData) {
			    		errs.push(this.signUpData[key]);
              if(!fkey) {
                fkey = key;
              }
			    	}
            self.set('step.message', this.signUpData[fkey][0]);
            let s = self.fc.querySelector('#'+fkey).parentNode.getAttribute('data-step');
            self.arrangeSteps(s);
            self.submiting = false;
          }
          self.isSigningUp = false;
        });
      }

      arrangeSteps(step) {
        const self = this;
        var scroll = 0;
        var _newStep = step;
        this.steps.forEach(function(item) {
          var _step = parseInt(item.getAttribute('data-step'));
          scroll = self.currentScroll + (Math.abs(_newStep - self.currentStep) * self.stepHeight);
          if(_newStep > self.currentStep) {
            scroll = self.currentScroll + -(Math.abs(_newStep - self.currentStep) * self.stepHeight);
          }

          var translateY = 'translateY(' + scroll + 'px)';

          if ( _step == _newStep) {
            item.style.opacity = 1;
            item.style.transform = 'scaleX(1) ' + translateY;
            item.querySelector('input').removeAttribute('disabled');
            item.querySelector('input').focus();
          } else {
            item.style.opacity = 0.5;
            if( _step > _newStep ) {
              let scale = 1 - ((_step - _newStep) * 0.1);
              item.style.transform = 'scaleX(' + scale + ') ' + translateY;
            } else {
              let scale = 1 - ((_newStep - _step) * 0.1);
              item.style.transform = 'scaleX(' + scale + ') ' + translateY;
            }
            item.querySelector('input').setAttribute('disabled', 'disabled');
          }
        });
        self.currentScroll = scroll;
        self.currentStep = _newStep;

      }

      inputListenEvents() {
        const self = this;

        this.steps.forEach(function(step) {
          const eStep = step.getAttribute('data-step');
          const _question = step.getAttribute('data-question');
          var question = _question;

          var focus = function() {

            self.activeStep = eStep;
            self.arrangeSteps(eStep);

            if( eStep == 2 ) {

              question = _question.replace('%name', self.name || '');

            }

            self.set('step.no', eStep);
            self.set('step.question', question);

          };

          const blur = function() {

            let hasError = self.hasError(this, this.getAttribute('data-validate'));
            if( hasError ) {
              // this.focus();
              self.set('step.message', this.getAttribute('data-message-' + hasError[0]));
              return;
            }
            self.set('step.message', null);

          };

          const keydown = function(e) {
            const kc = e.keyCode;
            // console.log(e);
            if( ((e.shiftKey && kc == 9) || (e.shiftKey && kc == 13)) && self.currentStep != 1 ) {
              e.preventDefault();
              e.stopPropagation();
              self.arrangeSteps(parseInt(self.currentStep) - 1);
              return;
            }
            if( (kc == 13 || kc == 9) && self.currentStep < self.totalSteps ) {
              if(!self.validate(self.currentStep)) return;;
              e.preventDefault();
              e.stopPropagation();
              self.arrangeSteps(parseInt(self.currentStep) + 1);
              return;
            }

            if( (kc == 13 || kc == 9) && self.currentStep == self.totalSteps ) {
              self.next = true;
            }
          }

          let input = step.querySelectorAll('input')[0];
          // input.removeEventListener('focus', focus);
          // input.removeEventListener('blur', blur);

          input.addEventListener('focus', focus);
          // input.addEventListener('blur', blur);
          input.addEventListener('keydown', keydown);


        });

      }

      hasError(element, validate) {
        if(!validate) return false;

        const e = element;
        const val = e.value;
        const validations = validate.split('|');
        var errs = [];
        validations.forEach(function(item) {
          switch (item) {
            case 'required':

              if( val && val != '' && val != null && val != 'undefined' ) {
                // no error
              } else {
                errs.push(item);
              }
              break;

            case 'email':

              let reEmail = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if( ! reEmail.test(val) ) {
                errs.push(item);
              }
              break;

            case 'number':

              let reNum = /^[0-9]+$/;
              if( ! reNum.test(val) ) {
                errs.push(item);
              }
              break;

            case 'match':
              if( val != e.getAttribute('data-match-to') ) {
                errs.push(item);
              }
              break;

          }
        });

        if( errs.length )return errs;

        return false;
      }

      tooglePassword() {
        this.isPasswordHidden = !this.isPasswordHidden;
      }

      validate(step) {
        var input = this.fc.querySelector('[data-step="' + step + '"]')
                            .querySelector('input');
        let hasError = this.hasError(input, input.getAttribute('data-validate'));
        if( hasError ) {
          this.set('step.message', input.getAttribute('data-message-' + hasError[0]));
          input.focus();
          return false;
        }
        this.set('step.message', null);
        return true;
      }

      touchScrollEvents() {
        const self = this;
        var handleStart = function(e) {
          self.startY = e.touches[0].clientY;
        }

        var handleMove = function(e) {
          self.endY = e.touches[0].clientY;
          var diff = self.endY - self.startY;
          if(Math.abs(diff) > (self.stepHeight/2)) {
            if ( diff < 0 ) {
              // will not prceed if validation is not satisfied
              if(!self.validate(self.currentStep)) return;

              if( self.currentStep < self.totalSteps)
                self.arrangeSteps(parseInt(self.currentStep) + 1);
            } else {
              if( self.currentStep != 1)
                self.arrangeSteps(parseInt(self.currentStep) - 1);
            }
            self.startY = self.endY;
          }
        }

        var wheelMovement = 0;
        var handleWheel = function(e) {
          var deltaY = e.deltaY;
          wheelMovement += deltaY;

          if(Math.abs(wheelMovement) < 50) {
            return;
          }

          var _newStep = parseInt(self.currentStep) - 1;
          if(wheelMovement > 0) {
            _newStep = parseInt(self.currentStep) + 1;
            wheelMovement = 0;
            // will not prceed if validation is not satisfied
            if(!self.validate(self.currentStep)) return;
          }

          wheelMovement = 0;
          if(_newStep < 1) {
            self.arrangeSteps(1);
            return;
          }
          if(_newStep > self.totalSteps) {
            self.arrangeSteps(self.totalSteps);
            return;
          }

          self.arrangeSteps(_newStep);
        }

        this.fc.addEventListener("touchstart", handleStart, false);
        this.fc.addEventListener("touchmove", handleMove, false);
        this.fc.addEventListener("wheel", handleWheel, false);

      }

      _myPropChanged(changeRecord) {

      }

      updateEmail(provider) {
        const _email = this.email;
        if ( _email.lastIndexOf('@') >= 1) {
          var email = _email.substring(0, _email.lastIndexOf('@') + 1);
          this.email = email + provider;
          return;
        }
        this.email += '@' + provider;
      }

      gmail() {
        this.updateEmail('gmail.com');
      }

      outlook() {
        this.updateEmail('outlook.com');
      }

      icloud() {
        this.updateEmail('icloud.com');
      }

      _passwordState(isPasswordHidden) {
        if ( ! isPasswordHidden ) {
          this.togglePasswordText = 'Hide';
          this.$.password.setAttribute('type', 'text');
        } else {
          this.togglePasswordText = 'Show';
          this.$.password.setAttribute('type', 'password');
        }
      }

      _submitingChange(submiting) {
        if(submiting) {
          this.signUp();
        }
      }


    }

    customElements.define(RegisterComponents.is, RegisterComponents);
	</script>
</dom-module>
