<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../grid-styles.html?v=1.0.16">
<link rel="import" href="../grid-icons.html?v=1.0.16">
<link rel="import" href="../components/ratings.html?v=1.0.16">

<dom-module id="grid-profile">
  <template>
    <style include="grid iron-flex">

      :host {
        display: block;
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0 auto;
        background: var(--dark-red);
      }

      .top-section {
        padding-bottom: 16px;
      }

      .top-section .avatar-name {
        margin-bottom: 16px;
      }

      .lower-section {
        background: #303030;
        padding: 16px;
      }

      .section-title {
        line-height: 40px;
      }

      .section-title .title {
        font-size: 18px;
      }

      div.divider {
        padding: 8px 0;
      }

      div.divider hr {
        margin: 0;
        opacity: 0.12;
      }

      .chip {
        padding-right: 16px;
      }

      .white-7 {
        color: rgba(255, 255, 255, 0.7);
      }

      .stats {
        padding: 0 8px;
        text-align: center;
        border-right: 1px solid #FFFFFF;
      }

      .stats:last-child {
        padding-right: 0px;
        border-right: none;
      }

      .num {
        font-size: 24px;
      }

      .name {
        font-size: 34px;
      }

      main {
        padding-bottom: 0;
      }

      a {
        text-decoration: none;
        color: #FFFFFF;
      }

      .center {
        text-align: center;
      }

      .time {
        font-size: 12px;
        opacity: 0.7;
      }

    </style>

    <!-- <app-location route="{{route}}" use-hash-as-path></app-location> -->
    <app-location route="{{route}}" ></app-location>

		<app-route route="{{route}}"
		    pattern="/profile"
		    data="{{routeData}}"
		    tail="{{subroute}}"></app-route>

		<app-route route="{{subroute}}"
		    pattern="/:id"
		    data="{{subrouteData}}"></app-route>

    <div id="toolbar" class="toolbar dred-bg">
      <paper-icon-button icon="first-page" class="white pointer" on-click="redirectHome"></paper-icon-button>
      <span class="flex"></span>
      <!-- <paper-icon-button icon="create" class="white pointer" on-click="editProfile"></paper-icon-button> -->
      <!-- <paper-icon-button icon="more-vert" class="white pointer"></paper-icon-button> -->
    </div>

    <main class="scroll-area flex layout vertical">
      <section class="p-y-1 top-section dred-bg">

        <div class="layout horizontal avatar-name">
          <div class="flex">
            <span class="flex m-0 white name">[[user.name]]</span>
            <span class="block white">
              @[[user.username]] 
              <template is="dom-if" if="[[user.confirmed]]">
                <iron-icon class="white" icon="grid:verified"></iron-icon>
              </template>
            </span>
          </div>
          <img on-click="editProfile" class="circle" src$="[[_profileImage(user.profile.profile_image_url)]]" avatar$="[[user.name]]">
        </div>

        <div class="layout horizontal white">
          <div class="flex m-0">
            <span class="block" style="height: 28px;">
              <!-- <iron-icon icon="star"></iron-icon>
              <iron-icon icon="star"></iron-icon>
              <iron-icon icon="star"></iron-icon>
              <iron-icon icon="star"></iron-icon>
              <iron-icon icon="star"></iron-icon>
               -->
               <grid-ratings rate="[[rate]]"></grid-ratings>
            </span>
            <span class="block white-7">[[user.reviews.length]] Ratings</span>
          </div>
          <div class="stats">
            <span class="block num">[[user.jobs_count]]</span>
            <span class="block white-7">Posts</span>
          </div>
          <div class="stats">
            <span class="block num">[[user.bids_count]]</span>
            <span class="block white-7">Bids</span>
          </div>
        </div>

      </section>

      <section class="p-y-1 lower-section flex">

        <div class="white">
          <div class="layout horizontal white section-title">
            <span class="flex title">About</span>
            <span class="red pointer" on-click="redirectAbout">Edit</span>
            <!-- <span class="red">More</span> -->
          </div>
          <p class="white">
            [[user.profile.bio]]
          </p>
          <template is="dom-if" if="[[!user.profile.bio]]" >
            Set it now
          </template>
        </div>

        <!-- <div class="divider"><hr/></div>

        <div>
          <div class="white section-title">
            <span class="title">Metrics</span>
          </div>
          <p class="white">
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
          </p>
        </div> -->

        <div class="divider"><hr/></div>

        <div>
          <div class="layout horizontal white section-title">
            <span class="flex title">Skills</span>
            <span class="red pointer" on-click="redirectProfileSkills">Edit</span>
          </div>
          <div class="skills-container">
            <!-- <div hidden$="[[skills]]" class="white">Loading your awesome skills...</div> -->
            <template is="dom-if" if="[[isSkillsLoading]]">
              <div class="center">
                <paper-spinner class="white" active></paper-spinner>
              </div> 
            </template>
            <template is="dom-repeat" items="[[skills]]" as="skill">
              <div class="chip">
                <span>[[skill.skill]]</span>
              </div>
            </template>
          </div>
        </div>

        <div class="divider"><hr/></div>
        
        <div>
          <div class="layout horizontal white section-title">
            <span class="flex title">Recent Posts</span>
          </div>
          <div class="white" role="listbox" style="margin: 0 -16px;">
            <template is="dom-if" if="[[isRecentPostsLoading]]">
              <div class="center">
                <paper-spinner class="white" active></paper-spinner>
              </div> 
            </template>
            <template is="dom-if" if="[[!isRecentPostsLoading]]">
              <template is="dom-repeat" items="[[recentPosts]]" as="job" >
                <a href$="/@[[user.username]]/posts/[[job.id]]">
                  <paper-item>
                    <paper-item-body two-line>
                      <div>[[job.name]]</div>
                      <div secondary>Date needed: [[_fromNow(job.date)]]</div>
                      <paper-ripple></paper-ripple>
                    </paper-item-body>
                    <div class="time" data-time$="[[job.created_at]]">[[_fromNow(job.created_at)]]</div>
                  </paper-item>
                </a>
              </template>
              <template is="dom-if" if="[[!recentPosts.length]]">
                <paper-item>No recent posts</paper-item>
              </template>
            </template>
          </div>
        </div>

        <div class="divider"><hr/></div>
        
        <div>
          <div class="layout horizontal white section-title">
            <span class="flex title">Completed Jobs</span>
          </div>
          <div class="white" role="listbox" style="margin: 0 -16px;">
            <template is="dom-if" if="[[isCompletedJobsLoading]]">
              <div class="center">
                <paper-spinner class="white" active></paper-spinner>
              </div> 
            </template>
            <template is="dom-if" if="[[!isCompletedJobsLoading]]">
              <template is="dom-repeat" items="[[completedJobs]]" as="job" >
                <a href$="/@[[user.username]]/posts/[[job.job.id]]">
                  <paper-item>
                    <paper-item-body two-line>
                      <div>[[job.job.name]]</div>
                      <div secondary>Date needed: [[_fromNow(job.job.date)]]</div>
                      <paper-ripple></paper-ripple>
                    </paper-item-body>
                    <div class="time" data-time$="[[job.job.created_at]]">[[_fromNow(job.job.created_at)]]</div>
                  </paper-item>
                </a>
              </template>
              <template is="dom-if" if="[[!completedJobs.length]]">
                <paper-item>No completed jobs</paper-item>
              </template>
            </template>
          </div>
        </div>
        
        <div class="divider"><hr/></div>
        
        <div>
          <div class="layout horizontal white section-title">
            <span class="flex title">Reviews</span>
          </div>
          <div class="white" role="listbox" style="margin: 0 -16px;">
            <template is="dom-if" if="[[isReviewsLoading]]">
              <div class="center">
                <paper-spinner class="white" active></paper-spinner>
              </div> 
            </template>
            <template is="dom-if" if="[[!isReviewsLoading]]">
              <template is="dom-repeat" items="[[reviews]]" as="review" >
                <a href$="/@[[user.username]]/posts/[[review.job.id]]">
                  <paper-item>
                    <paper-item-body two-line>
                      <div><grid-ratings rate="[[review.stars]]"></grid-ratings></div>
                      <div secondary>[[review.review]]</div>
                      <paper-ripple></paper-ripple>
                    </paper-item-body>
                    <div class="time" data-time$="[[review.created_at]]">[[_fromNow(review.created_at)]]</div>
                  </paper-item>
                </a>
              </template>
              <template is="dom-if" if="[[!reviews.length]]">
                <paper-item>No completed jobs</paper-item>
              </template>
            </template>
          </div>
        </div>

      </section>
    </main>

    <!-- <a href="/profile/skills">Skills</a> -->

    <iron-pages attr-for-selected="data-page" selected="[[subPage]]">

      <section data-page="setup" class="sub-page">
        <grid-setup id="setup"></grid-setup>
      </section>

      <section data-page="skills" class="sub-page">
        <grid-profile-skills id="skills"></grid-profile-skills>
      </section>

      <section data-page="edit" class="sub-page">
        <grid-profile-edit id="edit"></grid-profile-edit>
      </section>

      <section data-page="about" class="sub-page">
        <grid-profile-about id="about"></grid-profile-about>
      </section>

    </iron-pages>

  </template>

  <script>

    class GridProfile extends GridNavigation(ReduxBehavior(Polymer.Element)) {

      static get is() { return 'grid-profile'; }

      static get properties() {
        return {
          user: {
            type: Object,
            statePath: 'user'
          },
          skills: {
            type: Object,
            statePath: 'skills'
          }
        }
      }

      static get observers() {
        return [
          '_subrouteChange(subroute)',
          '_subrouteDataChange(subrouteData)',
        ]
      }

      static get actions() {
  			return {
  				setSkills(skills) {
  					return {
  						type: 'SET_SKILLS',
  						skills: skills
  					}
  				}
  			};
  		}

      constructor() {
        super();
        
        this.isSkillsLoading = true;
        this.isRecentPostsLoading = true;
        this.isCompletedJobsLoading = true;
        this.isReviewsLoading = true;
      }


      connectedCallback() {
        super.connectedCallback();

        const getLiveData = (url) => {
          return gAxios.get(url, {
            headers: {}
          }).catch(function(){
            return null;
          });
        };

        const getChachedData = (url) => {
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            return gAxios.get(url, {
              headers: { 'Cached': 'yes'}
            }).catch(function(){
              return null;
            });
          } else {
            return Promise.resolve(null);
          }
        };

        getLiveData(`/users/${this.user.id}/recent/jobs`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.recentPosts = res.data;
            this.isRecentPostsLoading = false;
            return true;
          }
          return false;   
        });

        getChachedData(`/users/${this.user.id}/recent/jobs`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.recentPosts = res.data;
            this.isRecentPostsLoading = false;
            return true;
          }
          return false;
        });
        
        getLiveData(`/users/${this.user.id}/skills`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.isSkillsLoading = false;
            this.dispatch('setSkills', res.data);
            return true;
          }
          return false;   
        });

        getChachedData(`/users/${this.user.id}/skills`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.isSkillsLoading = false;
            this.dispatch('setSkills', res.data);
            return true;
          }
          return false;
        });
        
        getLiveData(`/users/${this.user.id}/completed/jobs`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.completedJobs = res.data.completed_jobs;
            this.isCompletedJobsLoading = false;
            return true;
          }
          return false;   
        });

        getChachedData(`/users/${this.user.id}/completed/jobs`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.completedJobs = res.data.completed_jobs;
            this.isCompletedJobsLoading = false;
            return true;
          }
          return false;
        });
        
        getLiveData(`/users/${this.user.id}/reviews`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.reviews = res.data;
            this.isReviewsLoading = false;
            return true;
          }
          return false;   
        });

        getChachedData(`/users/${this.user.id}/reviews`).then(res => {
          if(!res) return false;
          if(res.data) {
            this.reviews = res.data;
            this.isReviewsLoading = false;
            return true;
          }
          return false;
        });

        // gAxios.get(`/users/${this.user.id}/recent/jobs`)
        // .then( res => {
        //   // this.dispatch('setSkills', res.data);
        //   this.recentPosts = res.data;
        //   this.isRecentPostsLoading = false;
        // });
        
        // gAxios.get(`/users/${this.user.id}/skills`)
        // .then( res => {
        //   this.isSkillsLoading = false;
        //   this.dispatch('setSkills', res.data);
        // });

        // gAxios.get(`/users/${this.user.id}/completed/jobs`)
        // .then( res => {
        //   this.completedJobs = res.data.completed_jobs;
        //   this.isCompletedJobsLoading = false;
        // });
        
        // gAxios.get(`/users/${this.user.id}/reviews`)
        // .then( res => {
        //   // console.log(res.data);
        //   this.reviews = res.data;
        //   this.isReviewsLoading = false;
        // });

        const main = this.shadowRoot.querySelector('main');
        
        const scroll = () => {
          if( main.scrollTop > 0 ) {
            this.shadowRoot.querySelector('#toolbar').classList.add('shadow');
          } else {
            this.shadowRoot.querySelector('#toolbar').classList.remove('shadow');
          }
        };

        main.addEventListener('scroll', scroll);

        LetterAvatar.transform();

        let sumStar = 0;

        if(this.user.reviews) {
          const totalNumReviews = this.user.reviews.length;
          
          this.user.reviews.forEach( review => {
            sumStar += review.stars;
          });

          if(sumStar == 0) {
            this.rate = 0;
          } else {
            this.rate = Math.floor(sumStar/totalNumReviews);
          }

        } else {
          this.rate = 0;
        }


      }

      editProfile() {
        this.redirect('/profile/edit')
      }

      redirectAbout() {
        this.redirect('/profile/about');
      }

      _subrouteChange(subroute) {
				if( subroute.path == '' ) {
					this.set('subrouteData.id', null);
          this.subPage = null;
				}
			}

      _subrouteDataChange(subrouteData) {
        const self = this;
        if( subrouteData.id ) {
          if(!this.shadowRoot.querySelector(`#${subrouteData.id}`)) {
            self.subPage = null;
          }
          Polymer.Base.importHref(
						'/elements/thegrid/pages/profile/grid-profile-' + subrouteData.id + '.html',
						() => {
              self.subPage = subrouteData.id;
						}
					);
        } else {
          self.subPage = null;
        }
      }

      _profileImage(img) {
        if( img ) {
          return this.url.API_BASE_URL + '/uploads/' + img;
        }
        if(this.user) return LetterAvatar(this.user.name, '64');//return this.url.API_BASE_URL + '/storage/avatars/profile_avatar_placeholder_large.png';

        return LetterAvatar('Grid', 64);

      }

      _fromNow(date) {
        return moment(date).fromNow();
      }

    }

    customElements.define(GridProfile.is, GridProfile);
	</script>
</dom-module>
