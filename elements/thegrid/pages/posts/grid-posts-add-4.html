<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../../behaviors/form-slider-behavior.html">
<link rel="import" href="../../../../../behaviors/map-behavior.html">
<link rel="import" href="../../grid-styles.html">
<link rel="import" href="../../grid-icons.html">

<dom-module id="grid-posts-add-4">
	<template>
		<style include="grid iron-flex">
			:host {
				height: 100%;
				background: var(--dark-grey);
				display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
         -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
			}
		</style>

		<div id="toolbar" class="toolbar dgrey-bg">
			<div class="flex">
				<paper-icon-button icon="chevron-left" class="white pointer" on-click="goBack"></paper-icon-button>
			</div>
			<div id="indicator"></div>
			<div class="flex align-right" style="padding-right: 8px;">
				<span id="next" class="white pointer" on-click="submit" hidden$="[[!readyPost]]">Post</span>
			</div>
		</div>

		<main class="flex">

			<div class="p-y-1">

				<div class="header-text-container">
					<h1 class="header-text m-0">
						<span hidden$="[[step.message]]">[[step.question]]</span>
						<span hidden$="[[!step.message]]">[[step.message]]</span>
					</h1>
				</div>
				<form class="form">

					<div class="input-group suffix" >
						<textarea rows="6" class="input" value="{{details::input}}" style="resize: none; height: 150px; padding: 16px;" placeholder="Start typing.."></textarea>
						<div class="addon-suffix has-button flex layout vertical" style="height: 150px;">
							<paper-icon-button icon="grid:attachment" on-click="selectFile"></paper-icon-button>
							<span class="flex"></span>
						</div>
					</div>

				</form>
				<input type="file" id="files" on-change="previewFiles" multiple/>
				<img id="aaa" style="width: 100px;" />
				<div id="previews"></div>
			</div>
		</main>
	</template>

	<script>
		class GrdiPostsAdd4 extends
			FormSliderBehavior(GridNavigation(ReduxBehavior(Polymer.Element))) {

			static get is() { return 'grid-posts-add-4'; }

			static get properties() {
				return {
					user: {
						type: Object,
						statePath: 'user'
					},
					auth: {
						type: Boolean,
						statePath: 'auth'
					},
					posts: {
						type: Object,
						statePath: 'posts'
					},
					data: {
						type: Object,
						notify: true
					},
					
				}
			}

			static get observers() {
				return [
					'_formDone(details)',
					'_filesChange(files)'
				]
			}

			static get actions() {
				return {
					addPost(post) {
						return {
							type: 'ADD_POST',
							post: post
						}
					}
				};
			}

			constructor() {
				super();
				this.readyPost = false;
				this.map = null;

				this.files = [];//new FormData();
				this.formData = new FormData();
			}

			connectedCallback() {
				const self = this;
				super.connectedCallback();
				// this.initForm();
				this.set('step.message', 'Add a brief description.');

				// clear form after adding and rearrange steps
				window.addEventListener('done-posting', () => {
                    this.readyPost = false;
                    this.details = '';
				});

			}

			goBack() {
				if(this.data.category == 1) {
					this.redirect('/posts/add/#3');
					return;
				}
				this.redirect('/posts/add/#2');
			}

			submit() {
        this.data.details = this.details;

				var files    = this.shadowRoot.querySelector('#files').files;


				const data = {
					user_id: this.user.id,
					name: this.data.what,
					price: this.data.price,
					lat: this.data.lat,
					lng: this.data.lng,
					location: this.data.where,
					date: this.data.when,
					category_id: this.data.category,
					skills: this.data.skills,
					details: this.details,
					files: files
				};
				
				this.formData.append('user_id', this.user.id);
				this.formData.append('name', this.data.what);
				this.formData.append('price', this.data.price);
				this.formData.append('lat', this.data.lat);
				this.formData.append('lng', this.data.lng);
				this.formData.append('location', this.data.where);
				this.formData.append('date', this.data.when);
				this.formData.append('category_id', this.data.category);
				this.formData.append('skills', this.data.skills);
				this.formData.append('details', this.details);
				// this.formData.append('files', files);

				// dispatch posting event
				window.dispatchEvent(new CustomEvent('posting'));

				gAxios.post('/users/' + this.user.id + '/jobs', this.formData)
					.then(res => {
						var data = res.data;

						this.dispatch('addPost', data);

						this.redirectHome();

						// set marker options
						data.isMyPost = true;
						data.isBidded = false;

						// add new marker to the map
						this.gmap.newMarker(data);

						// dispatch event
						window.dispatchEvent(new CustomEvent('user:posted', { detail: data }) );

					}).catch(err => {
						if (err.response) {
							alert('Oops something went wrong.. \n Please reload the page.');
							window.location.href = '/';
						}
					}).then(() => {
						// dispatch event to clear the form
						window.dispatchEvent(new CustomEvent('done-posting'));
					});
			}

			selectFile() {
				this.shadowRoot.querySelector('#files').click();
			}

			previewFiles() {
				var preview = this.shadowRoot.querySelector('#aaa');
				var previews = this.shadowRoot.querySelector('#previews');
				var file    = this.shadowRoot.querySelector('#files').files[0];
				var files    = this.shadowRoot.querySelector('#files').files;
				// console.log('files', files);

				for (var i = 0, f; f = files[i]; i++) {
					let reader  = new FileReader();
					let img = document.createElement('img');
					img.style.width = '100px';

					// this.files.append('img' + i, f);
					this.formData.append(`files[]`, f);
					// this.push('files', f);

					reader.onloadend = () => {
						img.src = reader.result;
					}

					if (f) {
						reader.readAsDataURL(f);
						
					} else {
						img.src = "";
					}

					previews.appendChild(img);
				}

				// gAxios.post('/users/' + this.user.id + '/upload', this.files)
        // .then( res => {
				// 	console.log(res);
        // }).catch( err => {
        //   console.log(err.response);
        // });
				
			}

			_filesChange(files) {
				console.log('this.files', files);
			}

			_formDone(details) {
				this.readyPost = false;
				if (details) {
					this.readyPost = true;
				}
			}

		}

		customElements.define(GrdiPostsAdd4.is, GrdiPostsAdd4);
	</script>
</dom-module>