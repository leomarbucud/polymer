<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../../behaviors/form-slider-behavior.html?v=1.0.3">
<link rel="import" href="../../../../../behaviors/map-behavior.html?v=1.0.3">
<link rel="import" href="../../grid-styles.html?v=1.0.3">
<link rel="import" href="../../grid-icons.html?v=1.0.3">

<dom-module id="grid-posts-edit-4">
	<template>
		<style include="grid iron-flex">
			:host {
				height: 100%;
				background: var(--light-grey);
				display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
         -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
			}

			#previews {
				display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
         -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
			}

			#previews .wrap {
				margin: 5px 0;
			}

			.file {
				display: inline-block;
				position: relative;
				color: #FFFFFF;
				/* height: 33px; */
				/* line-height: 33px; */
				background: rgba(33, 33, 33, 0.87);
				border-radius: 2px;
				padding: 4px 4px;

			}

			.file img {
				width: 24px;
				height: 24px;
				vertical-align: middle;
			}

			.file span {
				line-height: 25px;
				margin: 0 5px;
				font-size: 14px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.file iron-icon {
				cursor: pointer;
			}

		</style>

		<div id="toolbar" class="toolbar lgrey-bg">
			<!-- <div class="flex"> -->
				<paper-icon-button icon="chevron-left" class="red pointer" on-click="goBack"></paper-icon-button>
			<!-- </div> -->
			<div class="flex"></div>
			<!-- <div class="flex align-right"> -->
				<!-- <span id="next" class="white pointer" on-click="submit" hidden$="[[!readyPost]]">Post</span> -->
				<paper-button id="next" class="white pointer" on-click="submit" hidden$="[[!readyPost]]">Update</paper-button>
			<!-- </div> -->
		</div>

		<main class="flex">

			<div class="p-y-1">

				<div class="header-text-container">
					<h1 class="header-text m-0">
						<span hidden$="[[step.message]]">[[step.question]]</span>
						<span hidden$="[[!step.message]]">[[step.message]]</span>
					</h1>
				</div>
				<form class="form">

					<div class="input-group suffix" >
						<textarea rows="6" class="input" value="{{details::input}}" style="resize: none; height: 150px; padding: 16px;" placeholder="Start typing.."></textarea>
						<div class="addon-suffix has-button flex layout vertical" style="height: 150px;">
							<paper-icon-button icon="grid:attachment" on-click="selectFile"></paper-icon-button>
							<span class="flex"></span>
						</div>
					</div>

				</form>

				<input type="file" id="files" on-change="previewFiles" multiple style="position: absolute; left: -99999px; top: -99999px;"/>
				
				<div id="previews">
					<template is="dom-repeat" items="[[files]]" as="file">
						<div class="wrap">
							<div class="file layout horizontal">
								<img id="file-[[index]]" src$="[[_fileReader(file, index)]]" />
								<span class="flex">[[file.name]]</span>
								<iron-icon icon="close" on-click="removeFile"></iron-icon>
							</div>
						</div>
					</template>
				</div>
			</div>
		</main>
	</template>

	<script>
		class GrdiPostsEdit4 extends
		FormSliderBehavior(
			GridNavigation(
				ReduxAsyncActionBehavior(ReduxBehavior(Polymer.Element)))) {

			static get is() { return 'grid-posts-edit-4'; }

			static get properties() {
				return {
					user: {
						type: Object,
						statePath: 'user'
					},
					auth: {
						type: Boolean,
						statePath: 'auth'
					},
					posts: {
						type: Object,
						statePath: 'posts'
					},
					data: {
						type: Object,
						notify: true
					},
					
				}
			}

			static get observers() {
				return [
					'_formDone(details)',
					'_filesChange(files)',
					'_dataChange(data)'
				]
			}

			constructor() {
				super();
				this.readyPost = false;
				this.map = null;

				this.files = [];//new FormData();
				
			}

			connectedCallback() {
				const self = this;
				super.connectedCallback();
				// this.initForm();
				this.set('step.message', 'Add a brief description.');

				// clear form after adding and rearrange steps
				window.addEventListener('done-posting', () => {
                    // this.readyPost = false;
                    // this.details = '';
										this.files = this.data.files;
				});

			}

			goBack() {
				if(!this.data) return;
				if(this.data.category == 1) {
					this.redirect(`/posts/edit/${this.data.id}#3`);
					return;
				}
				this.redirect(`/posts/edit/${this.data.id}#2`)
			}

			submit() {
        this.data.details = this.details;

				// var files    = this.shadowRoot.querySelector('#files').files;


				// const data = {
				// 	user_id: this.user.id,
				// 	name: this.data.what,
				// 	price: this.data.price,
				// 	lat: this.data.lat,
				// 	lng: this.data.lng,
				// 	location: this.data.where,
				// 	date: this.data.when,
				// 	category_id: this.data.category,
				// 	skills: this.data.skills,
				// 	details: this.details
				// };

				let formData = new FormData();
				
				formData.append('id', this.data.id);
				formData.append('user_id', this.user.id);
				formData.append('name', this.data.what);
				formData.append('price', this.data.price);
				formData.append('lat', this.data.lat);
				formData.append('lng', this.data.lng);
				formData.append('location', this.data.where);
				formData.append('date', this.data.when);
				formData.append('category_id', this.data.category);
				if(this.data.skills) {
					// if(this.data.skills.length) {
						formData.append('skills', JSON.stringify(this.data.skills));
					// }
				}
				formData.append('details', this.details);

				if(this.files.length) {
					this.files.forEach( file => {
						if(file.id) {
							formData.append('files[]', JSON.stringify(file));
						} else {
							formData.append('files[]', file);
						}
					});
				}
				// formData.append('files', files);

				// dispatch posting event
				window.dispatchEvent(new CustomEvent('posting'));

				gAxios.post(`/users/${this.user.id}/jobs/edit`, formData)
					.then(res => {
						var data = res.data;

						this.redirect(`/posts/${data.id}`);

						this.dispatch('updatePost', data);

						this.gmap.updateMarker(data);

					}).catch(err => {
						if (err.response) {
							alert('Oops something went wrong.. \n Please reload the page.');
							window.location.href = '/';
						}
					}).then(() => {
						// dispatch event to clear the form
						window.dispatchEvent(new CustomEvent('done-posting'));
					});
			}

			selectFile() {
				this.shadowRoot.querySelector('#files').click();
			}

			previewFiles() {

				const files = this.shadowRoot.querySelector('#files').files;

				let err = [];

				for (var i = 0, f; f = files[i]; i++) {

					if(this.files.length == 5) {
						err.push('Only 5 files can be uploaded.');
						break;
					}

					let validTypes = false;
	
					switch (f.type) {
						case 'image/jpeg':
						case 'image/png':
						case 'application/pdf': {
							validTypes = true;
						}
					}

					if(validTypes) {
						if(f.size <= 1000000) {
							this.push('files', f);
						} else {
							err.push(`${f.name} is greater than 1mb.`);
						}
					} else {
						err.push(`${f.name} is not allowed to upload.`);
					}
					
				}

				if(err.length) {
					alert(err.join('\n'));
				}
				
			}

			removeFile(e) {
				// console.log(e.model.file);
				const file = e.model.file;
				const index = this.files.indexOf(file);

				if(index == -1) return;

				let files = this.files.slice(0);
				files.splice(index, 1);
				this.set('files', files);
			}

			_fileReader(file, index) {
				const previews = this.shadowRoot.querySelector('#previews');
				if(file.id) {
					if(file.type == 'jpeg' || file.type == 'png') {
						setTimeout( () => {
							previews.querySelector(`img#file-${index}`).src = `${this.url.API_BASE_URL}/uploads/${file.path}`;
						}, 100);
					} else if( file.type == 'pdf') {
						setTimeout( () => {
							previews.querySelector(`img#file-${index}`).src = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAAN2AAADdgF91YLMAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAdFQTFRF////4uXn8VZC4uXn4uXn4uXn8VZC4uXn4uXnwMbL4uXn8VZC8VZC4uXnsLe9srm/tbvBvsTJv8XKyc7SytHYzNLYzNPZzNPazdHV0tje1tvf29/h4OPl4aKc4uXn5NbW7G5f7Ih87Wtb8GJQ8GRS8VZC8VdD8VhE8VlF8VlG8VpG8VtH8VtI8VxJ8l5L8l9M8mBN8mFO8mJP8mNQ8mNR8mVS82lX82pY82tZ82ta82xa825d829d83Fg83Jh83Rj9HVl9HZm9Hpq9Hts9Hxs9H1u9H5u9H5v9YFy9YJ09YN09YR19YV39Yd59Yh69Yl79Yp99Yt99ox/9o6A9o6B9pCD9pOG9pSI9paJ9paK95mN95qO95uP956S956T96CV96GW96SZ+Kab+Kec+Kqg+bGo+bKp+bOr+bWt+buz+r+4+sO8+sW++sW/+sa/+sfB+8rE+83H+87I+9HL+9PO+9XQ/NXQ/NfT/NnU/NvW/NzY/N3Y/N/b/ODc/OHd/eHe/eLe/ePg/eTh/ebj/ebk/ejl/ern/ero/ezq/u7s/vDu/vHv/vLw/vLx/vPy/vTy/vTz/vX0/vj3/vj4//n4//r5//r6//v7//z7//7+////6Yan7AAAAA50Uk5TAAEaJG5+prK0wObm6vXU4MSnAAADiElEQVR42u3baVfTQBQGYJaWYpGqLLIHUKYFQcUFFBfcNxAVEXcFBQVcse5SFUVREEVFseTXmmmatmmH1uTemfFD3k/cSU7mKZmbA+mZrKw0yXV7vIrNrMgCJ9tVqNiPDyzIzlcg8YEFLgUIAApyC8EAmMCtwAEggQcDABF4UQAAgYIDsC/AAtgWoAHsCvAANgWIAHsCTIAtASrAjgAXYEOADLAuwAZYFqADrArwARYFHADWBDwAlgRcAFYEfAAWBFDAaqgACijyAQVQQLEPKIACqlYBBVCAUu6DCcAAZQ1MAAco5aC7gABQqoqL7HejgpTKEnaEAZYTiAMsIxAIYAtEApgCoQCWQCyAIRAMSBWIBqQIhAOSBeIBSQIJALNABsAkkAJIFMgBJAgkAeICWYCYQBrAEMgDRAUSAbpAJiAikAqgArkATSAZoFTKBigO4D8E5OQVEE5pqK/NDMhZSThmfW1GQB7hmvqMgAK+gIaMAMI5DsABOAAHYAOwoe+qnrN7G+Oj/h0dkbQ3J53euLMjls0YgO0zaix/xrZGR3umY4PzT663xU+/MRc/XQ0HN8IBg2pivpzRP/+UaXSuxzi7bdF0QL0IB4yar/hzNx1sMQ+qS7eb9LMPJR3owgF8HKMJfqeXfOE3AG9fagn91md6zALMDvtxAPf1H1sf0queMgAH9EW3fyhMq3MxwGKLET/GIkwAkKZ3WjFsBmg5QtfpdHMMgNuGiQByWSvGUwDkKC1vigAc1IoPqQAS1MoJEYA+rXjKAHTT/vALADzSihEGoJ3Wu4wu+BRN8DgywD9ML3+eAfD/iraHuQ0XtiEBQgM0t0KRj9fKADTRTjyZ+iA6TdCfhEvHCAPQSev2FMDzADogPEhYgAta+cPognBvNPvQFmEszzoJCxB4T5/RHNtwapRmqHePMZgEoM8n9YqI5wAbcI0uwcmAJEBH/3jk7nQT4YCvs1rmo6vjDuEFGNEueZcJSGyOAcINcMJYX6a8Ns3/+bAxvmVBVV8h/1U8OnOvNWWwa8KY/Nvkg/5N8QOXQm+6nH9MHIADcAAgAOcXlXWyX9XWSH5Zva5U6uv6uprSEstfWJTgpkw2oEIyYG21VEBZRbXzrZkDcAAOwDrAy3d+L/ctnxni4b7pNUPc3Lf9pk9hLveNz+nj4r/1O23ys/lvfk/3+3f90/zA7f/L9p/Hbbr/fwHUnx9+J46GvgAAAABJRU5ErkJggg==`;
						}, 100);
					}
					return;
				}
				
				let reader  = new FileReader();
				reader.onloadend = () => {
					if(file.type.indexOf('pdf') != -1) {
						previews.querySelector(`img#file-${index}`).src = `data:image/png;base64,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
`;
					} else {
						previews.querySelector(`img#file-${index}`).src = reader.result;
					}
				}
				if (file) {
					reader.readAsDataURL(file);
				} else {
					previews.querySelector(`img#file-${index}`).src = '';
				}
			}

			_filesChange(files) {
				// console.log('this.files', files);
			}

			_formDone(details) {
				this.readyPost = false;
				if (details) {
					this.readyPost = true;
				}
			}

			_dataChange(data) {
        if(!data) return;

				this.details = data.details;
				this.files = data.files;
      }

		}

		customElements.define(GrdiPostsEdit4.is, GrdiPostsEdit4);
	</script>
</dom-module>