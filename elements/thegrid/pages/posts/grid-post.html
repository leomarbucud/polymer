<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../grid-styles.html?v=1.0.17">
<link rel="import" href="../../grid-icons.html?v=1.0.17">
<link rel="import" href="../../components/ratings.html?v=1.0.17">
<link rel="import" href="../../components/carousel.html?v=1.0.17">
<link rel="import" href="../../components/detail-text.html?v=1.0.17">
<link rel="import" href="../../components/time-remaining.html?v=1.0.17">
<link rel="import" href="../../components/line-chart.html?v=1.0.17">

<dom-module id="grid-post">
  <template>
    <style include="grid grid-progress grid-tabs iron-flex">
       :host {
        display: block;
        background: var(--light-grey);
        height: 100%;
      }

      .details {
        margin-bottom: 16px;
      }

      .details.layout detail-text {
        max-width: 50%;
        min-width: 200px;
        width: 30%;
      }

      .legends {
        color: #FFFFFF;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 8px 0;
      }

      .legends label {
        font-weight: normal;
        font-size: 12px;
        line-height: 16px;
        display: flex;
        margin-left: 16px;
      }

      .legends label span {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 8px;
      }

      span.views {
        background: linear-gradient(270deg, #FF3B30 100%, #FF2D55 0%);
      }

      span.offers {
        background: linear-gradient(270deg, #FFFFFF 100%, #D5D5D5 0%)
      }

    </style>

    <div id="toolbar" class="toolbar dgrey-bg">
      <paper-icon-button icon="first-page" class="red" on-click="redirectHome"></paper-icon-button>
      <paper-icon-button icon="chevron-left" class="red" on-click="redirectPosts"></paper-icon-button>
      <span class="flex toolbar-title">[[ post.name ]]</span>
      <paper-icon-button icon="more-vert" class="red" on-click="redirectBack"></paper-icon-button>
    </div>
    <paper-tabs selected="{{selected_tab}}" class="tabs-dark">
      <paper-tab>About</paper-tab>
      <paper-tab>Offers</paper-tab>
      <paper-tab>Queries</paper-tab>
    </paper-tabs>
    
    <main class="scroll-area flex">

      <iron-pages selected="{{selected_tab}}">
        <section class="p-y-1 white">
          <div class="details">
            <time-remaining date="[[ post.date ]]" time-remaining="{{ time_remaining }}"></time-remaining>
            <detail-text label="Time Remaining" details="[[ time_remaining ]]"></detail-text>
          </div>
          <div class="details">
            <detail-text label="Location" details="[[ post.location ]]"></detail-text>
          </div>
          <div class="details">
            <detail-text label="Attachments" details="[[ docs_count ]] [[ _pluralize('file', docs_count) ]], [[ image_count ]] [[ _pluralize('image', image_count) ]]"></detail-text>
          </div>
          <div class="layout horizontal details">
            <detail-text label="Offers" details="[[ total_bidders ]] [[ _pluralize('Bid', total_bidders) ]]"></detail-text>
            <detail-text label="Queries" details="10 Questions"></detail-text>
          </div>
          <div class="layout horizontal details">
            <detail-text label="Highest Amount" details="AED [[ highest_bidder.price_bid ]]"></detail-text>
            <detail-text label="Lowest Amount" details="AED [[ lowest_bidder.price_bid ]]"></detail-text>
          </div>
          <div class="details">
            <detail-text label="Expected Amount" details="AED [[ post.price ]]"></detail-text>
          </div>
          <div class="details">
            <div class="legends">
              <label>
                <span class="views"></span>
                &nbsp;Views
              </label>
              <label>
                <span class="offers"></span>
                &nbsp;Offers
              </label>
            </div>
            <line-chart data="[[ chart_data ]]"></line-chart>
          </div>
        </section>
        <section class="p-y-1 white">
          Offers      
        </section>
        <section class="p-y-1 white">
          Queries      
        </section>
      </iron-pages>

    </main>

    <paper-dialog id="filesPreviewDialog" style="min-width: 300px;" class="dialog-dark">
      <h2>Files</h2>
      <paper-dialog-scrollable>
        <div id="docs-dialog"></div>
        <div id="carousel-dialog"></div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
    </paper-dialog>
    
    <paper-dialog id="awardDialog" class="dialog-dark">
      <h2>Award this job</h2>
      <div>
        <p>Are you sure you want to award this job to [[awardee.user.name]]?</p>
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus on-tap="awardJob">Yes</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class GridPost extends GridNavigation(ReduxBehavior(Polymer.Element)) {

      static get is() { return 'grid-post'; }

      static get properties() {
        return {
          user: {
            type: Object,
            statePath: 'user'
          },

          auth: {
            type: Boolean,
            statePath: 'auth'
          },

          posts: {
            type: Array,
            statePath: 'posts'
          },

          inbox: {
            type: Array,
            statePath: 'inbox'
          },

          isLoading: {
            type: Boolean,
            value: false
          }

        }
      }

      static get observers() {
        return [
          '_postsChange(posts)',
          '_postChange(post)',
          '_postIdChange(postId)',
        ]
      }

      constructor() {
        super();

        this.selected_tab = 0;

      }

      connectedCallback() {
        super.connectedCallback();

      }

      renderPost(post) {
        if (!this.user || !post) return;
        this.post = post;
        this.isLoading = false;

        this._awarded = false;
        this._inProgress = false;
        this._review = false;
        this.star = 1;
        this._showReview = false;
        this.lowest_bidder = { price_bid: 0 };
        this.highest_bidder = { price_bid: 0 };
        this.total_bidders = 0;
        this.docs_count = 0;
        this.image_count = 0;

        this._setChartData(post);
        this._setFiles(post.files);
        this._setRanking(post.bidders);

      }

      viewOnMap() {
        if (!this.post && this.map) return;

        const job = this.post;
        const position = new google.maps.LatLng(job.lat, job.lng);

        this.map.setCenter(position);
        this.map.setZoom(20);
        this.redirectHome();
      }

      openAwardJobDialog(e) {
        const bidder = e.model.bidder;

        const awardDialog = this.shadowRoot.querySelector('#awardDialog');

        this.awardee = bidder;

        awardDialog.open();
      }

      awardJob() {
        if(!this.auth) return;

        if(!this.awardee) return;

        const bidder = this.awardee;
        this.isLoading = true;

        gAxios.post(`/users/${this.user.id}/bids/${bidder.id}/approve`, {
          job_id: this.post.id,
          user_id: bidder.user.id
        }).then( res => {
          this.dispatch('updatePost', res.data);
          
          // window.dispatchEvent( new CustomEvent('user:grant_job', { detail: res.data.winner }));

          // to notify other bidders

          this.post.bidders.forEach(bidder => {
            bidder.winner_user_id = res.data.winner.user_id;
            window.dispatchEvent( new CustomEvent('user:grant_job', { detail: bidder }));
          });
        }).then( () => {
          this.isLoading = false;
        });
      }

      markInProgress() {
        if(!this.post) return;
        if(this.post.status != 1) return;
        
        this.isLoading = true;
        gAxios.post(`/users/${this.user.id}/jobs/${this.post.id}/status`, {
          status: 2
        }).then( res => {
          // console.log(res.data);
          this.dispatch('updatePost', res.data);

          let detail = {
            winner_user_id: res.data.winner.user_id,
            bid_id: res.data.winner.bid_id
          };
          
          window.dispatchEvent( new CustomEvent('user:job_in_progress', { detail: detail }));
        
        }).catch( err => {

        }).then( () => {
          this.isLoading = false;
        });
      }

      markCompleted() {
        if(!this.post) return;
        if(this.post.status != 3) return;
        
        this.isLoading = true;
        gAxios.post('/users/' + this.user.id + '/jobs/' + this.post.id + '/status', {
          status: 4
        }).then( res => {
          // console.log(res.data);
          this.dispatch('updatePost', res.data);

          let detail = {
            winner_user_id: res.data.winner.user_id,
            bid_id: res.data.winner.bid_id
          };
          
          window.dispatchEvent( new CustomEvent('user:job_complete', { detail: detail }));
        
        }).catch( err => {

        }).then( () => {
          this.isLoading = false;
        });
      }

      showReview(event = true) {
        this._showReview = true;
      }

      submitReview() {
        if(!this.auth) return;

        this.isLoading = true;

        gAxios.post('/users/' + this.user.id + '/review', {
          user_id: this.post.winner.user.id,
          job_id: this.post.id,
          review: this.review,
          stars: this.rate
        }).then( res => {
          
          this.dispatch('updatePost', res.data);

          let detail = {
            winner_user_id: res.data.winner.user_id,
            bid_id: res.data.winner.bid_id
          };
          
          window.dispatchEvent( new CustomEvent('user:job_review', { detail: detail }));
        
        }).catch( err => {

        }).then( () => {
          this.isLoading = false;
        })
      }

      messageBidder() {
        if( !this.post.winner ) return;

        if( this.post.conversation ) {
          this.redirect('/inbox/' + this.post.conversation.id);
          return;
        }

        this.isLoading = true;
        gAxios.post('/users/' + this.user.id + '/inbox', {
          job_id: this.post.id,
          user_id_1: this.user.id,
          user_id_2: this.post.winner.user.id
        }).then( res => {
          
          var convoExist = this.inbox.find(item => {
            return item.id == res.data.id;
          });
          
          if(!convoExist) {
            this.dispatch('addInbox', res.data);
            let detail = res.data;
            detail.to = this.post.winner.user.id;
            window.dispatchEvent(new CustomEvent('user:create_conversation', { detail: res.data }));
          }
          this.redirect('/inbox/' + res.data.id);

        }).then( () => {
          this.isLoading = false;
        });
      }

      viewFiles(e) {
        const files = e.model.bidder.files;

        if(files.length) {
          const carousel = this.shadowRoot.querySelector('#carousel-dialog');
          const docs = this.shadowRoot.querySelector('#docs-dialog');
          
          if(files.length) {
            
            let my_carousel = document.createElement('my-carousel');
            let pdf = document.createElement('div');

            files.forEach( file => {
              let allowFile = false;
              switch (file.type) {
                case 'jpeg':
                case 'png': {
                  allowFile = true;
                  break;
                }
                case 'pdf': {
                  let a = document.createElement('a');
                  a.href = this._getFilePath(file.path);
                  a.setAttribute('download', true);
                  a.textContent = file.original_name;
                  pdf.appendChild(a);
                  break;
                }
              }
              if( !allowFile ) return;
              let img = document.createElement('img');
              let div = document.createElement('div');

              div.style.backgroundImage = `url(${this._getFilePath(file.path)})`;
              div.style.backgroundSize = 'cover';
              div.style.backgroundPosition = 'center';

              my_carousel.appendChild(div);
            });

            carousel.innerHTML = '';
            carousel.appendChild(my_carousel);

            docs.innerHTML = '';
            docs.appendChild(pdf);

            const dialog = this.shadowRoot.querySelector('#filesPreviewDialog');
            dialog.fitInto = this;
            dialog.open();

          } else {
            carousel.innerHTML = '';
          }
        }
      }

      editPost() {
        if(!this.post) return;

        this.redirect(`/posts/edit/${this.post.id}/#1`);
      }

      _nextStatus(status) {
        if(!this.post) return false;

        
        if( this.post.status + 1 == status ) {
          return true;
        }

        return false;
      }

      _postChange(post) {
        if (!post) return;
        this.renderPost(post);
      }

      _postIdChange(postId) {
        if (!postId) return;
        if (!this.auth) return;
        if (!this.posts) return;
        if (this.post) return;
        this.isLoading = true;
        this.posts.map(post => {
          if (parseInt(post.id) === parseInt(this.postId)) {
            this.renderPost(post);
            this.isLoading = false;
          }
        });
      }

      _postsChange(posts) {
        posts.forEach(post => {
          if (parseInt(post.id) == parseInt(this.postId)) {
            this.renderPost(post);
          }
        });
      }

      _fromNow(date) {
        return moment(date).fromNow();
      }

      _details(details) {
        if (details) return details;

        return '';
      }

      _compareWinnerBidder(id1, id2) {
        return id1 == id2;
      }

      _getFilePath(path) {
        return `${this.url.API_BASE_URL}/uploads/${path}`;
      }

      _pluralize(text, count) {
        if( count > 1 ) return `${text}s`;

        return text;
      }

      _setRanking(bidders) {
        if( !bidders ) return;
        if( !bidders.length ) return;
				const sorted = bidders.slice().sort((a,b)=>a.price_bid - b.price_bid)
				this.lowest_bidder = sorted[0];
        this.highest_bidder = sorted[sorted.length-1];
        this.total_bidders = bidders.length;
      }

      _setFiles(files) { 
        if( !files ) return;
        if( !files.length ) return;
        let docs = 0;
        let image = 0;
        files.forEach( file => {
          let allowFile = false;
          switch (file.type) {
            case 'jpeg':
            case 'png': {
              image++;
              break;
            }
            case 'docx':
            case 'pdf': {
              docs++;
              break;
            }
          }
        });
        this.docs_count = docs;
        this.image_count = image;
      }

      _setChartData(post) {
        let labels = [];
        let views = [];
        let offers = [];

        for( let i = 6; i >= 0; i-- ) {
          labels.push(moment().subtract('days', i).format('MM/DD'));
        }

        labels.forEach( label => {
          let count = 0;
          post.views_this_week.forEach( view => {
            const day = moment(view.day).format('MM/DD');
            if( day == label ) {
              count = view.count;
            }
          });

          views.push(count);
        });
        
        labels.forEach( label => {
          let count = 0;
          post.offers_this_week.forEach( offer => {
            const day = moment(offer.day).format('MM/DD');
            if( day == label ) {
              count = offer.count;
            }
          });

          offers.push(count);
        });

        this.chart_data = {
          labels: labels,
          views: views,
          offers: offers
        }
      }

    }

    customElements.define(GridPost.is, GridPost);
  </script>
</dom-module>