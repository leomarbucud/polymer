<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/elements/thegrid/grid-styles.html">
<link rel="import" href="/elements/thegrid/components/login-components.html">
<link rel="import" href="/redux/grid-redux-store.html">

<dom-module id="grid-login">
  <template>
    <style include="iron-flex grid">

      :host {
        display: block;
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0 auto;
        background: linear-gradient(209.36deg, #FF3B30 0%, #FF2D55 100%);
      }
      .header-action {
        height: 56px;
        padding: 16px;
      }

      .loading {
        background: linear-gradient(209.36deg, #FF3B30 0%, #FF2D55 100%);
      }

    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>

		<app-route route="{{route}}"
		    pattern="/login/:provider/:token/:secret/:setup"
		    data="{{loginData}}"></app-route>

    <div class="header-action flex layout horizontal">
      <iron-icon icon="close" class="white pointer" on-click="close"></iron-icon>
      <span class="flex"></span>
      <span class="white pointer" on-click="register">SIGN UP</span>
    </div>

    <login-components is-logging-in="{{isLoggingIn}}"
                      is-logged-in="{{isLoggedIn}}"
                      login-attempt="{{loginAttempt}}"
                      login-error="{{loginError}}" ></login-components>

    <paper-toast id="loginErrToast" duration="0" class="fit-bottom">
      <div class="layout horizontal">
        <span class="flex">Invalid user credentials.</span>
        <span><a href="/#account/forgot" class="red anchor">FORGOT?</a></span>
      </div>
    </paper-toast>

    <template is="dom-if" if="[[isLoggingIn]]">
      <div class="overlay loading">
        <div>
          <img src="/assets/images/thegrid.svg" alt="THE GRID"/>
          <br/>
          <paper-spinner active$="[[isLoggingIn]]"></paper-spinner>
      </div>
      </div>
    </template>

  </template>

  <script>

    class GridLogin extends ReduxBehavior(Polymer.Element) {

        static get is() { return 'grid-login'; }

        static get properties() {
          return {
            auth: {
              type: Boolean,
              statePath: 'auth'
            },

            setupAccount: {
              type: Boolean,
              value: false,
              notify: true
            }
          }
        }

        static get observers() {
          return [
            '_onLoginError(loginAttempt)',
            '_checkLogin(isLoggedIn)',
            '_loginDataChange(loginData)'
          ];
        }

        static get actions() {
    			return {

            assignToken(token) {
              return {
                type: 'ASSIGN_TOKEN',
                token: token
              }
            }
    			};
    		}

        register() {
          window.location.href = REGISTER_URL;
        }

        close() {
          window.location.href = HOME_URL;
        }

        _onLoginError(loginAttempt) {
          if ( loginAttempt > 0 ) {
            this.$.loginErrToast.fitInto = this;
            this.$.loginErrToast.open();
          }
        }

        _checkLogin(isLoggedIn) {
          if(isLoggedIn) {
            this.$.loginErrToast.close();
            window.location.href = HOME_URL;
          }
        }

        _loginDataChange(loginData) {
          if(!loginData) return;
          if(!loginData.provider) return;
          if(!loginData.secret) return;
          if(!loginData.token) return;

          const self = this;

          if( self.isLoggingIn ) return;

          self.isLoggingIn = true;

          axios.post(API_BASE_URL + '/oauth/token', {
            grant_type: 'social',
            client_id: 2,
            client_secret: loginData.secret,
            network: loginData.provider,
            access_token: loginData.token
          })
          .then( res => {
            self.isLoggingIn = false;
            self.isLoggedIn = true;
            if(loginData.setup == 1) {
              self.setupAccount = true;
            }
            self.dispatch('assignToken', res.data);
          })
          .catch( err => {

            self.isLoggingIn = false;

          });


        }
    }

    customElements.define(GridLogin.is, GridLogin);

	</script>
</dom-module>
