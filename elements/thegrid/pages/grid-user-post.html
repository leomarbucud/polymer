<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../grid-styles.html">
<link rel="import" href="../grid-icons.html">
<link rel="import" href="../components/carousel.html">

<dom-module id="grid-user-post">
	<template>
		<style include="grid iron-flex">
			:host {
				display: block;
				position: relative;
				height: 100%;
				background: var(--dark-grey);
			}

			img.circle {
				height: 64px;
				width: 64px;
				border-radius: 50%;
			}

			.user-info .name {
				padding-left: 16px;
			}

			.user-info .name span {
				color: #FFFFFF;
				font-size: 32px;
				font-weight: 400;
				display: block;
			}

			.user-info .name small {
				font-size: 14px;
				color: #FFFFFF;
				opacity: 0.7;
			}

			.chip {
				padding-right: 16px;
			}

			#bid-box {
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 0px;
				width: 100%;
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				background: #424141;
				padding: 16px 0;
			}

			#bid-box .addon-suffix {
				padding: 0;
			}

			main {
				padding-bottom: 100px;
			}

			.section-title, .section-details {
        display: flex;
        justify-content: left;
        align-items: center;
      }

      .section-title .title {
        font-size: 24px;
				color: #FFFFFF;
				font-weight: 400;
				line-height: 34px;
        margin-bottom: 8px;
      }

      div.divider {
        padding: 8px 0;
      }

      div.divider hr {
        margin: 0;
        opacity: 0.12;
      }

			my-carousel {
				margin-top: 16px;
  			margin-bottom: 8px;
        width: 100%;
        contain: content;
      }
      my-carousel::after {
        display: block;
        content: '';
        padding-top: 75%; /* 4:3 = height is 75% of width */
      }
      my-carousel img, my-carousel div {
        position: absolute;
        width: 100%;
        height: 100%;
				/* object-fit: cover; */
      }

			#previews {
				display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
         -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
			}

			#previews .wrap {
				margin: 5px 0;
			}

			.file {
				display: inline-block;
				position: relative;
				color: #FFFFFF;
				height: 33px;
				line-height: 33px;
				background: rgba(33, 33, 33, 0.87);
				border-radius: 2px;
				padding: 0 4px;
			}

			.file img {
				width: 24px;
				height: 24px;
				vertical-align: middle;
			}

			.file span {
				line-height: 25px;
				margin: 0 5px;
				font-size: 14px;
			}

			.file iron-icon {
				cursor: pointer;
			}


		</style>

		<div id="toolbar" class="toolbar">
			<paper-icon-button icon="close" class="red pointer" on-click="redirectHome"></paper-icon-button>
			<span class="flex"></span>
		</div>

		<main class="scroll-area flex">
			<section class="p-y-1 user-info">
				<div class="flex layout horizontal">
					<div class="avatar">
						<a href$="/@[[post.user.username]]"><img class="circle" src$="[[_profileImage(post.user.profile.profile_image_url)]]"></a>
					</div>
					<div class="name">
						<span>[[post.user.name]]</span>
						<small>[[_fromNow(post.created_at)]]</small>
					</div>
				</div>
			</section>


			<section class="p-y-1 white">
				<div class="section-title">
					<div class="flex">
						<span class="title">[[post.name]]</span>
						<small class="category block">Category: [[post.category.category]]</small>
						<small class="block">Location: [[post.location]]</small>
					</div>
					<paper-icon-button icon="grid:location" class="white" on-tap="viewOnMap"></paper-icon-button>
				</div>

				<div id="carousel"></div>

				<div class="divider"><hr/></div>

				<div class="section-title">
					<div class="flex">
						<span class="title">Details</span>
					</div>
				</div>

				<div class="section-details">
					<div class="flex">
						<span class="title">Budget</span>
						<!-- <iron-icon icon="grid:amount" class="white"></iron-icon> -->
					</div>
					<span>AED [[post.price]]</span>
				</div>

				<div class="section-details">
					<div class="flex">
						<span class="title">Job needed</span>
						<!-- <iron-icon icon="grid:clock" class="white"></iron-icon> -->
					</div>
					<span>[[_fromNow(post.date)]]</span>
				</div>
				
				<div class="section-details">
					<div class="flex">
						<span class="title">Posted</span>
						<!-- <iron-icon icon="grid:calendar" class="white"></iron-icon> -->
					</div>
					<span>[[_fromNow(post.created_at)]]</span>
				</div>

				<div hidden$="[[!hasPDF]]">
					<div class="section-details">
						<div class="flex">
							<span class="title">PDF</span>
						</div>
						<span><div id="docs"></div></span>
					</div>
				</div>

				<p>[[_details(post.details)]]</p>

				<template is="dom-if" if="[[isService]]">

					<div class="divider"><hr/></div>

					<div class="section-title">
						<div class="flex">
							<span class="title">Required Skills</span>
						</div>
					</div>

					<template is="dom-repeat" items="[[post.skills]]" as="skill">
						<div class="chip">
							<span>[[skill.skill]]</span>
						</div>
					</template>
					<template is="dom-if" if="[[!post.skills.length]]">
						<p>No set of skills provided.</p>
					</template>

				</template>
			</section>

		</main>
		<div id="bid-box">
			<template is="dom-if" if="[[user]]">
				<!-- <div class="divider p-y-1"><hr/></div> -->

				<template is="dom-if" if="[[bidded]]">
					<section class="p-y-1 w-100 white layout horizontal">
						<div class="flex">
							<span>You bidded:</span>
							<h2 class="title m-0">AED [[bidded_details.price_bid]]</h2>
						</div>
						<div class="layout vertical">
							<a href$="/bids/[[bidded_details.id]]" class="red">View details</a>
						</div>
					</section>
				</template>

				<!-- <section class="p-y-1 white">
					[[message]]
				</section> -->
				<template is="dom-if" if="[[canBid]]">
					<section class="p-y-1 w-100">
						<!--:start Bidding section -->
						<!-- <h2 class="title">Bid</h2> -->
						<span class="white">Bid</span>
						<span class="white">[[message]]</span>
						
						<form class="form" hidden$="[[checking]]">
							<div id="previews">
								<template is="dom-repeat" items="[[files]]" as="file">
									<div class="wrap">
										<div class="file">
											<img id="file-[[index]]" src$="[[_fileReader(file, index)]]" />
											<span>[[file.name]]</span>
											<iron-icon icon="close" on-click="removeFile"></iron-icon>
										</div>
									</div>
								</template>
							</div>
							<div class="input-group prefix suffix">
								<div class="addon-prefix">
									<span>AED </span>
								</div>
								<input id="price" id="priceBid" type="number" class="input" autofocus autocomplete="off" placeholder="Amount to Bid" value="{{price::input}}"
								 max$="[[post.price]]" on-keydown="priceBidEvent"/>

								 <div class="addon-suffix has-button">
										<paper-icon-button class="red" icon="grid:attachment" on-click="selectFile"></paper-icon-button>
										<paper-button class="red" on-tap="bid">Bid</paper-button>
								 </div>
							</div>
							<input type="file" id="files" on-change="previewFiles" multiple style="position: absolute; left: -99999px; top: -99999px;"/>
						</form>
						<!--:end Bidding section -->

					</section>
				</template>

			</template>

			<template is="dom-if" if="[[checking]]">
				<section class="p-y-1 relative">
					<div class="align-center">
						<paper-spinner active></paper-spinner>
					</div>
				</section>
			</template>

			<template is="dom-if" if="[[!user]]">
				<section class="p-y-1 white">
					<span class="pointer" on-click="redirectLogin">Login to bid on this job</span>
				</section>
			</template>
		</div>


		<template is="dom-if" if="[[isLoading]]">
			<div class="overlay dgrey-bg" style="margin-top: 63px;">
				<div class="align-center">
					<paper-spinner active$="[[isLoading]]"></paper-spinner>
				</div>
			</div>
		</template>

	</template>

	<script>
		class GridUserPost extends GridNavigation(ReduxBehavior(Polymer.Element)) {

			static get is() { return 'grid-user-post'; }

			static get properties() {
				return {
					user: {
						type: Object,
						statePath: 'user'
					}
				}
			}

			static get observers() {
				return [
					'_postIdChange(postId)',
					'_postUserId(post.user.id)',
					// '_userBidded(bidded)'
				]
			}

			static get actions() {
				return {
					addBid(bid) {
						return {
							type: 'ADD_BID',
							bid: bid
						}
					}
				};
			}

			constructor() {
				super();

				// initialize value
				this._initValue();
			}

			connectedCallback() {
				super.connectedCallback();

				// grid map is required so the map needs to be loaded
				Polymer.Base.importHref(
					'/elements/thegrid/components/grid-map.html',
					() => {
						// do something after elements has been imported
					}
				);

				
			}

			priceBidEvent(e) {
				if( e.keyCode == 13 ) {
					this.bid();
					e.preventDefault();
				}
			}

			_initValue() {
				this.isLoading = false;
				this.canBid = false;
				this.bidded = false;
				this.checking = false;
				this.isService = false;
				this.hasPDF = false;
				this.files = [];
			}

			viewOnMap() {
				if (!this.post && this.gmap.map) return;

				const job = this.post;
				const position = new google.maps.LatLng(job.lat, job.lng);

				this.gmap.map.setCenter(position);
				this.gmap.map.setZoom(20);
				this.redirectHome();
			}

			bid() {
				if (!this.post) return;
				
				if(!this.price) {
					this.message = '[Please enter the amount to bid.]';
					return;
				}
				this.message = '';
				// validate maximum bid
				if (parseFloat(this.price) > parseFloat(this.post.price)) {
					// alert user that max input is this.post.price
					this.message = '[Maximum bid is AED ' + this.post.price + ']';
				} else {

					this.checking = true;

					let formData = new FormData();

					formData.append('job_id', this.post.id);
					formData.append('price_bid', this.price);

					if(this.files.length) {
						this.files.forEach( file => {
							formData.append('files[]', file);
						});
					}

					gAxios.post('/users/' + this.user.id + '/bids', formData)
					.then(res => {
						this.bidded_details = res.data;
						this._userBidded(true);

						// update the marker
						this.updateMarker(this.post.id)

						this.dispatch('addBid', res.data);

						// dispatch event
						window.dispatchEvent(new CustomEvent('user:bidded', { detail: res.data }) );
					}).catch(err => {

					}).then(() => {
						this.checking = false;
					});

				}
			}

			updateMarker(id) {
				const marker = this.gmap.findBy( marker => {
					return marker.id == id;
				});
				if(marker){
					const _marker = marker[0];
					_marker.isBidded = true;

					// remove marker
					this.gmap.removeBy( marker => {
						return marker.id == id;
					});

					// add the updated marker
					this.gmap.newMarker(_marker);
				}
			}

			_postIdChange(postId) {
				if (!postId) return;
				this._initValue();
				this.isLoading = true;
				axios.get(this.url.API_URL + '/jobs/' + postId)
					.then(res => {
						this.post = res.data;
						if(this.post.category_id == 1) {
							this.isService = true;
						}

						const carousel = this.shadowRoot.querySelector('#carousel');
						const docs = this.shadowRoot.querySelector('#docs');

						if(this.post.files.length) {	
							
							let my_carousel = document.createElement('my-carousel');
							let pdf = document.createElement('div');

							this.post.files.forEach( file => {
								let allowFile = false;
								switch (file.type) {
									case 'jpeg':
									case 'png': {
										allowFile = true;
										break;
									}
									case 'pdf': {
										let a = document.createElement('a');
										a.href = this._getFilePath(file.path);
										a.setAttribute('download', true);
										a.textContent = file.original_name;
										pdf.appendChild(a);
										this.hasPDF = true;
									}
								}
								if( !allowFile ) return;
						
								let img = document.createElement('img');
								let div = document.createElement('div');
								img.setAttribute('data-src', this._getFilePath(file.path));

								div.style.backgroundImage = `url(${this._getFilePath(file.path)})`;
								div.style.backgroundSize = 'cover';
								div.style.backgroundPosition = 'center';

								my_carousel.appendChild(div);
							});

							carousel.innerHTML = '';
							carousel.appendChild(my_carousel);

							docs.innerHTML = '';
          		docs.appendChild(pdf);
						} else {
							carousel.innerHTML = '';
						}

					}).then(() => {
						this.isLoading = false;
					});
			}

			selectFile() {
				this.shadowRoot.querySelector('#files').click();
			}

			previewFiles() {

				const files = this.shadowRoot.querySelector('#files').files;

				let err = [];

				for (var i = 0, f; f = files[i]; i++) {

					if(this.files.length == 5) {
						err.push('Only 5 files can be uploaded.');
						break;
					}

					let validTypes = false;
	
					switch (f.type) {
						case 'image/jpeg':
						case 'image/png':
						case 'application/pdf': {
							validTypes = true;
						}
					}

					if(validTypes) {
						if(f.size <= 1000000) {
							this.push('files', f);
						} else {
							err.push(`${f.name} is greater than 1mb.`);
						}
					} else {
						err.push(`${f.name} is not allowed to upload.`);
					}
					
				}

				if(err.length) {
					alert(err.join('\n'));
				}
				
			}

			removeFile(e) {
				// console.log(e.model.file);
				const file = e.model.file;
				const index = this.files.indexOf(file);

				if(index == -1) return;

				let files = this.files.slice(0);
				files.splice(index, 1);
				this.set('files', files);
			}

			_fileReader(file, index) {
				const previews = this.shadowRoot.querySelector('#previews');
				let reader  = new FileReader();
				reader.onloadend = () => {
					if(file.type.indexOf('pdf') != -1) {
						previews.querySelector(`img#file-${index}`).src = `data:image/png;base64,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
`;
					} else {
						previews.querySelector(`img#file-${index}`).src = reader.result;
					}
				}
				if (file) {
					reader.readAsDataURL(file);
				} else {
					previews.querySelector(`img#file-${index}`).src = '';
				}
			}

			_fromNow(date) {
				return moment(date).fromNow();
			}

			_profileImage(img) {
				if (img) {
					return this.url.API_BASE_URL + '/storage/avatars/' + img;
				}
				if (this.post.user) return LetterAvatar(this.post.user.name, '64');//return this.url.API_BASE_URL + '/storage/avatars/profile_avatar_placeholder_large.png';

				return LetterAvatar('Grid', 64);

			}

			_postUserId(id) {
				if (!id) return;
				this.canBid = false;
				if (this.user) {
					if (this.user.id == id) {
						return;
					}
				} else {
					return;
				}
				this.message = '';
				this.checking = true;
				gAxios.get('/users/' + this.user.id + '/bid/check/' + this.post.id)
					.then(res => {
						// if( res.data.bidded ) {
						// 	this.bidded = true;
						// 	this.canBid = false;
						// } else {
						// 	this.bidded = false;
						// 	this.canBid = true;
						// }
						const data = res.data;
						if( data.bidded ) {
							this.bidded_details = res.data.bid;
						}
						this._userBidded(data.bidded);
					}).then(() => {
						this.checking = false;
					});
			}

			_userBidded(bidded) {
				this.bidded = bidded;
				if (bidded) {
					this.message = 'You already bidded to this post.';
					this.canBid = false;
					this.price = '';
				} else {
					this.message = '';
					this.canBid = true;
				}
			}

			_details(details) {
				if (details) return details;

				return '';
			}

			_getDistance(p1, p2) {
				if (!p1 || !p2) {
					return 0;
				}

				var R = 6371; // Radius of the Earth in km
				var dLat = (p2.lat() - p1.lat()) * Math.PI / 180;
				var dLon = (p2.lng() - p1.lng()) * Math.PI / 180;
				var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(p1.lat() * Math.PI / 180) * Math.cos(p2.lat() * Math.PI / 180) *
					Math.sin(dLon / 2) * Math.sin(dLon / 2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
				var d = R * c;
				return d;
			}

			_getFilePath(path) {
        return `${this.url.API_BASE_URL}/uploads/${path}`;
      }

		}

		customElements.define(GridUserPost.is, GridUserPost);
	</script>
</dom-module>