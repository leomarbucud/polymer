<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../grid-styles.html">

<dom-module id="grid-user-post">
	<template>
		<style include="grid iron-flex">
			:host {
				display: block;
				position: relative;
				height: 100%;
				background: var(--dark-grey);
			}

			img.circle {
				height: 64px;
				width: 64px;
				border-radius: 50%;
			}

			.user-info .name {
				padding-left: 16px;
			}

			.user-info .name span {
				color: #FFFFFF;
				font-size: 32px;
				font-weight: 400;
				display: block;
			}

			.user-info .name small {
				font-size: 14px;
				color: #FFFFFF;
				opacity: 0.7;
			}

			.chip {
				padding-right: 16px;
			}

			.title {
				font-size: 24px;
				color: #FFFFFF;
				font-weight: 400;
				line-height: 32px;
			}

			#bid-box {
				display: flex;
				align-items: center;
				justify-content: center;
				height: 100px;
				width: 100%;
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				background: #424141;
				padding: 16px 0;
			}

			#bid-box .addon-suffix {
				padding: 0;
			}

			main {
				padding-bottom: 100px;
			}
		</style>

		<div id="toolbar" class="toolbar">
			<paper-icon-button icon="close" class="red pointer" on-click="redirectHome"></paper-icon-button>
			<span class="flex"></span>
		</div>

		<main class="scroll-area flex">
			<section class="p-y-1 user-info">
				<div class="flex layout horizontal">
					<div class="avatar">
						<a><img class="circle" src$="[[_profileImage(post.user.profile.profile_image_url)]]"></a>
					</div>
					<div class="name">
						<span>[[post.user.name]]</span>
						<small>[[_fromNow(post.created_at)]]</small>
					</div>
				</div>
			</section>
			<section class="p-y-1 white">
				<h2 class="title">[[post.name]]</h2>
				<small class="category">Category: [[post.category.category]]</small>
				<h2 class="white">Budget AED [[post.price]]</h2>
				<span class="white">Job needed [[_fromNow(post.date)]]</span>
			</section>
			<section class="p-y-1 white">
				<h2 class="title">Details</h2>
				<p>[[_details(post.details)]]</p>
			</section>

			<section class="p-y-1 white">
				<h2 class="title">Skills Required</h2>
				<template is="dom-repeat" items="[[post.skills]]" as="skill">
					<div class="chip">
						<span>[[skill.skill]]</span>
					</div>
				</template>
				<template is="dom-if" if="[[!post.skills.length]]">
					<p>No set of skills provided.</p>
				</template>
			</section>

			<section class="p-y-1">
				<p><span class="white pointer" on-click="viewOnMap">View on map</span></p>
			</section>

		</main>
		<div id="bid-box">
			<template is="dom-if" if="[[user]]">
				<!-- <div class="divider p-y-1"><hr/></div> -->

				<template is="dom-if" if="[[bidded]]">
						<section class="p-y-1 w-100 white">
							<span>You bidded:</span>
							<h2 class="title m-0">AED [[bidded_details.price_bid]]</h2>
						</section>
				</template>

				<!-- <section class="p-y-1 white">
					[[message]]
				</section> -->
				<template is="dom-if" if="[[canBid]]">
					<section class="p-y-1 w-100">
						<!--:start Bidding section -->
						<!-- <h2 class="title">Bid</h2> -->
						<span class="white">Bid</span>
						<form class="form" hidden$="[[checking]]">
							<div class="input-group prefix suffix">
								<div class="addon-prefix flex layout horizontal">
									<span>AED </span>
								</div>
								<input id="price" id="priceBid" type="number" class="input" autofocus autocomplete="off" placeholder="Price" value="{{price::input}}"
								 max$="[[post.price]]" />

								 <div class="addon-suffix">
										<paper-button class="red" on-tap="bid">Bid</paper-button>
								 </div>
							</div>
							
						</form>
						<!--:end Bidding section -->

					</section>
				</template>

			</template>

			<template is="dom-if" if="[[checking]]">
				<section class="p-y-1 relative">
					<div class="align-center">
						<paper-spinner active></paper-spinner>
					</div>
				</section>
			</template>

			<template is="dom-if" if="[[!user]]">
				<section class="p-y-1 white">
					<span class="pointer" on-click="redirectLogin">Login to bid on this job</span>
				</section>
			</template>
		</div>


		<template is="dom-if" if="[[isLoading]]">
			<div class="overlay dgrey-bg" style="margin-top: 64px;">
				<div class="align-center">
					<paper-spinner active$="[[isLoading]]"></paper-spinner>
				</div>
			</div>
		</template>

	</template>

	<script>
		class GridUserPost extends GridNavigation(ReduxBehavior(Polymer.Element)) {

			static get is() { return 'grid-user-post'; }

			static get properties() {
				return {
					user: {
						type: Object,
						statePath: 'user'
					}
				}
			}

			static get observers() {
				return [
					'_postIdChange(postId)',
					'_postUserId(post.user.id)',
					// '_userBidded(bidded)'
				]
			}

			static get actions() {
				return {
					addBid(bid) {
						return {
							type: 'ADD_BID',
							bid: bid
						}
					}
				};
			}

			constructor() {
				super();

				// initialize value
				this._initValue();
			}

			connectedCallback() {
				super.connectedCallback();

				// grid map is required so the map needs to be loaded
				Polymer.Base.importHref(
					'/elements/thegrid/components/grid-map.html',
					() => {
						// do something after elements has been imported
					}
				);
			}

			_initValue() {
				this.isLoading = false;
				this.canBid = false;
				this.bidded = false;
				this.checking = false;
			}

			viewOnMap() {
				if (!this.post && this.map) return;

				const job = this.post;
				const position = new google.maps.LatLng(job.lat, job.lng);

				this.map.setCenter(position);
				this.map.setZoom(20);
				this.redirectHome();
			}

			bid() {
				if (!this.post) return;

				this.message = '';
				// validate maximum bid
				if (this.price > parseFloat(this.post.price)) {
					// alert user that max input is this.post.price
					this.message = 'Maximum bid is AED ' + this.post.price;
				} else {

					this.isLoading = true;

					gAxios.post('/users/' + this.user.id + '/bids', {
						job_id: this.post.id,
						price_bid: this.price
					}).then(res => {
						this.bidded_details = res.data;
						this._userBidded(true);
						this.dispatch('addBid', res.data);
					}).catch(err => {

					}).then(() => {
						this.isLoading = false;
					});

				}
			}

			_postIdChange(postId) {
				if (!postId) return;
				this._initValue();
				this.isLoading = true;
				axios.get(this.url.API_URL + '/jobs/' + postId)
					.then(res => {
						this.post = res.data;
					}).then(() => {
						this.isLoading = false;
					});
			}

			_fromNow(date) {
				return moment(date).fromNow();
			}

			_profileImage(img) {
				if (img) {
					return this.url.API_BASE_URL + '/storage/avatars/' + img;
				}
				if (this.post.user) return LetterAvatar(this.post.user.name, '64');//return this.url.API_BASE_URL + '/storage/avatars/profile_avatar_placeholder_large.png';

				return LetterAvatar('Grid', 64);

			}

			_postUserId(id) {
				if (!id) return;
				this.canBid = false;
				if (this.user) {
					if (this.user.id == id) {
						return;
					}
				} else {
					return;
				}
				this.message = '';
				this.checking = true;
				gAxios.get('/users/' + this.user.id + '/bid/check/' + this.post.id)
					.then(res => {
						// if( res.data.bidded ) {
						// 	this.bidded = true;
						// 	this.canBid = false;
						// } else {
						// 	this.bidded = false;
						// 	this.canBid = true;
						// }
						const data = res.data;
						if( data.bidded ) {
							this.bidded_details = res.data.bid;
						}
						this._userBidded(data.bidded);
					}).then(() => {
						this.checking = false;
					});
			}

			_userBidded(bidded) {
				this.bidded = bidded;
				if (bidded) {
					this.message = 'You already bidded to this post.';
					this.canBid = false;
					this.price = '';
				} else {
					this.message = '';
					this.canBid = true;
				}
			}

			_details(details) {
				if (details) return details;

				return 'No details provided.';
			}

			_getDistance(p1, p2) {
				if (!p1 || !p2) {
					return 0;
				}

				var R = 6371; // Radius of the Earth in km
				var dLat = (p2.lat() - p1.lat()) * Math.PI / 180;
				var dLon = (p2.lng() - p1.lng()) * Math.PI / 180;
				var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(p1.lat() * Math.PI / 180) * Math.cos(p2.lat() * Math.PI / 180) *
					Math.sin(dLon / 2) * Math.sin(dLon / 2);
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
				var d = R * c;
				return d;
			}

		}

		customElements.define(GridUserPost.is, GridUserPost);
	</script>
</dom-module>