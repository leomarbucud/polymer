<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../grid-styles.html">
<link rel="import" href="inbox/grid-conversation.html">

<dom-module id="grid-inbox">
  <template>
    <style include="grid iron-flex">

      :host {
        display: block;
        position: relative;
        height: 100%;
        background: var(--dark-grey);
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
         -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
      }

      .title h1 {
        font-weight: 400;
        font-size: 32px;
      }

      .row {
        color: #FFFFFF;
        padding: 8px 16px;
        position: relative;
        cursor: pointer;
      }

      .row .job-title {
        line-height: 24px;
        font-size: 18px;
      }

      .row [secondary] {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        opacity: 0.7;
      }

      .divider {
        padding: 0 16px;
      }

      .divider hr {
        margin: 0;
        opacity: 0.12;
      }

      .badge.unread {
        background: var(--red);
        font-size: 9px;
        width: 16px;
        height: 16px;
        display: block;
        text-align: center;
        line-height: 16px;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        right: 16px;
      }

      .time {
        font-size: 12px;
        position: absolute;
        top: 12px;
        right: 16px;
        opacity: 0.7;
      }

    </style>

    <app-location route="{{route}}" ></app-location>

		<app-route route="{{route}}"
		    pattern="/inbox"
		    data="{{routeData}}"
		    tail="{{subroute}}"></app-route>

		<app-route route="{{subroute}}"
		    pattern="/:id"
		    data="{{subrouteData}}"></app-route>

    <app-route route="{{route}}"
        pattern="/inbox/:id"
        data="{{conversation}}"></app-route>

    <div id="toolbar" class="toolbar dgrey-bg">
      <paper-icon-button icon="first-page" class="red pointer" on-click="redirectHome"></paper-icon-button>
      <span class="flex"></span>
      <paper-icon-button icon="search" class="red pointer"></paper-icon-button>
      <paper-icon-button icon="more-vert" class="red pointer" on-tap="openMenu"></paper-icon-button>
      <iron-dropdown id="menu" horizontal-align="right" vertical-align="top">
        <div slot="dropdown-content" class="dropdown-menu">
          <div class="item" on-click="populateInbox">
            <span>Refresh</span>
            <paper-ripple></paper-ripple>
          </div>
        </div>
      </iron-dropdown>
    </div>

    <main class="flex">
      <section class="p-y-1 title">
        <h1 class="white m-0">Inbox</h1>
      </section>
      <section class="list" id="post-list">
        <template id="inboxList" is="dom-repeat" items="[[conversations]]" as="convo" sort="_sortByUpdatedAt">
          <div class="row" on-click="viewConversation">
            <div class="job-title">[[convo.job.name]]</div>
            <div secondary>[[_lastMesage(convo.messages)]]</div>

            <div class="time" data-time$="[[convo.updated_at]]">[[_fromNow(convo.updated_at)]]</div>
            
            <template is="dom-if" if="[[_lastRecipient(convo.last_updated_by, convo.unread_count)]]">
              <span class="badge unread white">[[convo.unread_count]]</span>
            </template>
            <paper-ripple></paper-ripple>
          </div>
          <div class="divider"><hr/></div>
				</template>
      </section>
    </main>

    <iron-pages id="subPages" attr-for-selected="data-page" selected="[[subPage]]">

      <section data-page="conversation" class="sub-page">
        <grid-conversation conversation-id="[[conversation.id]]" gmap="[[gmap]]"></grid-conversation>
      </section>

    </iron-pages>

    <template is="dom-if" if="[[isLoading]]">
      <div class="overlay dgrey-bg" style="margin-top: 64px;">
        <div class="align-center">
          <paper-spinner active$="[[isLoading]]"></paper-spinner>
        </div>
      </div>
    </template>

  </template>

  <script>

    class GridInbox extends GridNavigation(ReduxBehavior(Polymer.Element)) {

      static get is() { return 'grid-inbox'; }

      static get properties() {
        return {

          user: {
            type: Object,
            statePath: 'user'
          },

          auth: {
            type: Boolean,
            statePath: 'auth'
          },

          inbox: {
            type: Array,
            statePath: 'inbox'
          },

          isLoading: {
            type: Boolean,
            value: true
          }
        }
      }

      static get observers() {
        return [
          '_subrouteChange(subroute)',
          '_subrouteDataChange(subrouteData)',
          '_inboxChange(inbox)'
        ]
      }

      static get actions() {
  			return {
          setInbox(inbox) {
  					return {
  						type: 'SET_INBOX',
  						inbox: inbox
  					}
          },

          addInbox(conversation) {
						return {
							type: 'ADD_INBOX',
							conversation: conversation
						}
          },

          addMessage(id, message) {
						return {
							type: 'ADD_MESSAGE',
							id: id,
              message: message
						}
          },

          addConversation(conversation) {
						return {
							type: 'UPDATE_CONVERSATION',
							conversation: conversation
						}
          },
          
        }
  		}

      constructor() {
        super();
        this._initSocketEvents();

        window.addEventListener('user:connected', e => {
          this.populateInbox();
				});
      }

      connectedCallback() {
        super.connectedCallback();
        this.populateInbox();
      }

      populateInbox() {
        if(!this.user) return;

        gAxios.get('/users/'+ this.user.id + '/inbox')
				.then( res => {
          var data = res.data;
					this.dispatch('setInbox', data.data);
					this.pagination = {
						total: data.total,
						per_page: data.per_page,
						current_page: data.current_page,
						last_page: data.last_page,
						next_page_url: data.next_page_url,
						prev_page_url: data.prev_page_url,
						from: data.from,
						to: data.to
					};
				}).then( () => {
          this.isLoading = false;
        });
      }

      viewConversation(e) {
        const inbox_id = e.model.convo.id;
        this.redirect('/inbox/' + inbox_id);
        // this._post = e.model.inbox;
      }

      openMenu() {
        this.$.menu.open();
      }

      refreshJobs() {
        this.populateJobs();
      }

      renderInbox(inbox) {
        if(!inbox) return;

        console.log('rendering inbox');

        const _inbox = inbox.slice(0);

        this.conversations = _inbox;

        for(var i = 0; i < _inbox.length; i++) {
          this.notifyPath('conversations.' + i + '.unread_count', _inbox[i].unread_count);
          this.notifyPath('conversations.' + i + '.updated_at', _inbox[i].updated_at);
          this.notifyPath('conversations.' + i + '.messages', _inbox[i].messages);
        }
        // this.set('conversations', []);
        setTimeout( () => {
          // this.set('conversations', _inbox);
        }, 10);

        //this.notifyPath('conversations', inbox);
        
        //this.shadowRoot.querySelector('#inboxList').render();
      }

      _inboxChange(inbox) {
        console.log('inbox change', inbox);
        this.renderInbox(inbox);
      }

      _lastRecipient(last_updated_by, unread_count) {
        if(!this.auth) return;
        return (this.user.id != last_updated_by && unread_count > 0);
      }

      _lastMesage(messages) {
        if(!messages.length) return 'Start a conversation...';

        var y = 'You: ';
        var m = messages[messages.length - 1].message;
        if(messages[messages.length - 1].author_id != this.user.id) {
          var y = '';
        }
        return y + m;
      }

      _fromNow(date) {
        return moment(date).fromNow();
        // return moment(date, "YYYY-MM-DD").endOf('minute').fromNow();
      }

      _subrouteChange(subroute) {
				if( subroute.path == '' ) {
					this.set('subrouteData.id', null);
          this.subPage = null;
				}
			}

      _subrouteDataChange(subrouteData) {
        const self = this;
        if( subrouteData.id ) {
          if( this.shadowRoot.querySelector('#posts-' + subrouteData.id) ) {
            Polymer.Base.importHref(
  						'/elements/thegrid/pages/inbox/grid-inbox-' + subrouteData.id + '.html',
  						() => {
                self.subPage = subrouteData.id;
  						}
  					);
          } else {
            // go to conversation by default
            self.subPage = 'conversation';
          }
        } else {
          self.subPage = null;
        }
      }

      _sortByUpdatedAt(a, b) {
				a = new Date(a.updated_at);
				b = new Date(b.updated_at);
				return b < a ? -1 : b > a ? 1 : 0;
			}

      _initSocketEvents() {

        // when user receive message
        socket.on('user:receive_message', data => {
          if(!this.auth) return;

          console.log('user receive', data);
          this.dispatch('addMessage', data.conversation_id, data);
          
        });

        // when message sent
        socket.on('user:sent_message', data => {
          if(!this.auth) return;
          
          console.log('user sent', data);
          this.dispatch('addMessage', data.conversation_id, data);
          
        });

        // when new conversation
        socket.on('user:create_conversation', data => {
          if(!this.auth) return;

          this.dispatch('addInbox', data);

        });

      }

    }

    customElements.define(GridInbox.is, GridInbox);
	</script>
</dom-module>
