<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../../bower_components/range-datepicker/range-datepicker.html">
<link rel="import" href="../../../bower_components/range-datepicker/range-datepicker-input.html">
<link rel="import" href="../../../behaviors/navigation-behavior.html">
<link rel="import" href="../grid-styles.html">

<dom-module id="grid-filter">
  <template>
    <style include="iron-flex grid">

      :host {
        position: relative;
        height: 100%;
        background: var(--dark-grey);
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
         -ms-flex-direction: column;
        -webkit-flex-direction: column;
        flex-direction: column;
      }

      #calendar {
        background: #424242;
        color: #FFFFFF;
      }

      .grid {
        --paper-input-container-input-color: #FFFFFF;
        --paper-input-container-label: #FFFFFF;
        --paper-input-container-focus-color: #FFFFFF;
      }

      paper-slider.red {
      --paper-slider-knob-color: #FF3B30;
      --paper-slider-active-color: #FF3B30;
      --paper-slider-pin-color: #FF3B30;
      }

      .fil {
        padding: 16px 0;
      }

      .slider {
        color: #FFFFFF;
      }
    
      .slider .label span {
        float: right;
      }

      .slider paper-slider {
        margin-top: 25px;
      }
      

    </style>

    <div class="toolbar">
      <paper-icon-button icon="close" class="white pointer" on-click="redirectHome"></paper-icon-button>
      <span class="flex"></span>
      <paper-button on-click="filter">Done</paper-button>
    </div>
    
    <main class="flex">
      <section class="p-y-1 title">
        <h1 class="white m-0">Filters</h1>
      </section>

      <section class="p-y-1">

        <div class="fil layout horizontal">
          <paper-input label="Date" value="From [[_stripYear(dateFromText)]] to [[_stripYear(dateToText)]]" on-click="openCalendar" readonly class="flex grid" style="margin-right: 16px;">
            <div slot="suffix">
              <iron-icon class="white" icon="arrow-drop-down"></iron-icon>
            </div>
          </paper-input>
          <template is="dom-if" if="[[auth]]">
            <paper-menu-button id="show-only" class="p-0" horizontal-align="left" vertical-align="top" ignore-select="true">
              <paper-input label="Show" value="[[showText]]" readonly class="grid" slot="dropdown-trigger" style="width: 150px;">
                <div slot="suffix">
                  <iron-icon class="white" icon="arrow-drop-down"></iron-icon>
                </div>
              </paper-input>
              <div slot="dropdown-content" class="dropdown-menu">
                <paper-item on-click="updateShow" data-show="m_p">My Posts</paper-item>
                <paper-item on-click="updateShow" data-show="m_b" >My Bids</paper-item>
              </div>
            </paper-menu-button>
          </template>

        </div>

        <div class="fil slider">
          <div class="label">Minimum Price (AED) <span>[[price]]</span></div>
          <paper-slider id="price" pin max="10000" step="100" value="{{price}}" class="red w-100"></paper-slider>
        </div>

        <div class="fil slider">
          <div class="label">Set Radius (KMS) <span>[[radius]]</span></div>
          <paper-slider id="radius" pin max="10" step="1" value="{{radius}}" class="red w-100"></paper-slider>
        </div>

      </section>

    </main>

    <paper-dialog id="calendar">
      <range-datepicker date-format="MM/DD/YYYY" force-narrow date-from="{{dateFrom}}" date-to="{{dateTo}}"></range-datepicker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-click="updateDate">Ok</paper-button>
      </div>
    </paper-dialog>

    <template is="dom-if" if="[[isLoading]]">
      <div class="overlay dgrey-bg">
        <div class="align-center">
          <paper-spinner active$="[[isLoading]]"></paper-spinner>
        </div>
      </div>
    </template>

  </template>

  <script>

    class GridFilter extends GridNavigation(ReduxBehavior(Polymer.Element)) {

        static get is() { return 'grid-filter'; }

        static get properties() {
          return {
            auth: {
              type: Boolean,
              statePath: 'auth'
            }
            
          }
        }

        constructor() {
          super();
          this.showText = 'My Posts';
          this.show = 'm_p';
          this.price = 0;
          this.radius = 0;
          this.dateFromText = moment(new Date()).format('MM/DD/YYYY');
          this.dateToText = moment(new Date()).format('MM/DD/YYYY');
        }

        openCalendar() {
          this.shadowRoot.querySelector('#calendar').open();
        }

        updateDate() {
          if(this.dateFrom) {
            this.dateFromText = moment.unix(this.dateFrom).format('MM/DD/YYYY');
            if(this.dateTo) {
              this.dateToText = moment.unix(this.dateTo).format('MM/DD/YYYY');
            } else {
              this.dateToText = this.dateFromText;
            }
          }
          
        }

        updateShow(e) {
          const target = e.target;
          const show = target.getAttribute('data-show');

          if(show == 'm_p') {
            this.showText = 'My Posts';
          } else if(show == 'm_b') {
            this.showText = 'My Bids';
          }

          this.show = show;

          this.shadowRoot.querySelector('#show-only').close();

        }

        filter() {
          if(!this.gmap) return;
 
          this.isLoading = true;
          
          const fetch = () => {
            this.isLoading = true;
            axios.get(`${this.url.API_URL}/job/all?lat=${this.gmap.currentLocation.lat}&lng=${this.gmap.currentLocation.lng}&rad=${this.radius}`)
            .then( res => {
              this.gmap.paintMarkers(res.data);
              this.isLoading = false;
              this.redirectHome();
            });
          };

          if(!this.gmap.currentLocation) {
            this.gmap.setCurrentPosition()
            .then( res => {
              fetch();
            });
          } else {
            fetch();
          }

        }

        redirectHome() {
          super.redirectHome();
          // this.classList.remove('active');
        }

        _stripYear(date) {
          return moment(new Date(date)).format('MM/DD');
        }


    }

    customElements.define(GridFilter.is, GridFilter);

	</script>
</dom-module>