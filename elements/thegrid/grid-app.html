<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">
<link rel="import" href="/bower_components/app-layout/app-layout.html">
<link rel="import" href="/bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="/bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/redux/grid-redux-store.html">
<link rel="import" href="/behaviors/index.html">
<link rel="import" href="/elements/thegrid/components/grid-map.html">
<link rel="import" href="/elements/thegrid/grid-styles.html">
<link rel="import" href="/elements/thegrid/components/mobile-header.html">

<dom-module id="grid-app">
	<template>

    <style include="grid">

			:host {
				display: block;
				width: 100%;
				height: 100%;
			}

			#startDrawer {
      --app-drawer-content-container: {
	        box-shadow: 1px 0 2px 1px rgba(0,0,0,0.18);
	      }
	    }

	    #endDrawer {
	      --app-drawer-content-container: {
	        box-shadow: -1px 0 2px 1px rgba(0,0,0,0.18);
	      }
	    }

	    app-header {
	      position: fixed;
	      top: 0;
	      left: 0;
	      width: 100%;
	      background-color: #4285f4;
	      color: #fff;
	    }

	    app-header paper-icon-button {
	      --paper-icon-button-ink-color: white;
	    }

			section .center-page {
				width: 400px;
        height: 600px;
			}
			@media (max-width: 600px) {
			  section .center-page {
			    width: 100%;
			    height: 100%;
			  }
			}

    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>

    <app-route id="authRoute" route="{{route}}"
        pattern="account/:page"
        data="{{pageData}}"
        tail="{{pageTail}}"></app-route>

		<app-route route="{{route}}"
        pattern="confirmation/:token"
        data="{{confirmation_token}}"></app-route>

		<grid-map user="[[user]]"></grid-map>

		<mobile-header drawer-opened="{{drawerOpened}}"></mobile-header>

		<iron-pages attr-for-selected="data-page" selected="[[pageData.page]]">

	    <section data-page="login" class="overlay">
	      <div class="center-page">
					<grid-login id="login"></grid-login>
				</div>
	    </section>

	    <section data-page="register" class="overlay">
				<div class="center-page">
					<grid-register id="register"></grid-register>
				</div>
	    </section>

			<section data-page="forgot" class="overlay">
				<div class="center-page">
					<grid-forgot id="forgot"></grid-forgot>
				</div>
	    </section>

			<section data-page="reset-password" class="overlay">
				<div class="center-page">
					<grid-reset-password id="reset"></grid-reset-password>
				</div>
	    </section>

	  </iron-pages>

		<app-drawer id="drawer" align="start" swipe-open opened="{{drawerOpened}}">
			<grid-drawer></grid-drawer>
		</app-drawer>

	</template>

	<script>

		class GridApp extends ReduxBehavior(Polymer.Element) {

			static get is() { return 'grid-app'; }

			static get properties() {
				return {

					user: {
						type: Object,
						statePath: 'user'
					},

					token: {
						type: Object,
						statePath: 'token'
					},

				}
			}

			static get observers() {
				return [
					'_routeChange(route)',
					'_pageChange(pageData)',
					'_tokenChange(token)',
					'_drawerState(drawerOpened)',
					'_hasConfirmationToken(confirmation_token)'
				]
			}

			static get actions() {
  			return {

  				loggedUser(user) {
  					return {
  						type: 'LOGGED_USER',
  						user: user
  					}
  				}

				}
			}

			constructor() {
				super();
				this._checkLogin();
			}

			connectedCallback() {
				super.connectedCallback();
			}

			_checkLogin() {
				const self = this;

				if(checkLogin()) {
					self.isLoggedIn = true;
					this.set('pageData', null);

					gAxios.get('user')
		      .then( res => {

						self.dispatch('loggedUser', res.data);

		      }).catch( err => {
		        console.log('error');
		      });
				}
			}

			_tokenChange(token) {
				if(token) {
					localStorage.setItem('token', JSON.stringify(token));
					this._checkLogin();
				}
			}

			_routeChange(route) {
				if( route.path == '' ) {
					this.set('pageData.page', null);
				}
			}

			_pageChange(pageData) {
				if ( checkLogin() ) {
					this.set('pageData', null);
					return;
				}
				if ( pageData.page ) {
          Polymer.Base.importHref(
						'/elements/thegrid/pages/grid-' + pageData.page + '.html',
						() => {
							// do something after elements has been imported
						}
					);
        }
			}

			_drawerState(drawerOpened) {
				const d = this.$.drawer;
				d.opened = drawerOpened;
				if(drawerOpened) {
					Polymer.Base.importHref(
						'/elements/thegrid/components/drawer.html',
						() => {
							// do something after elements has been imported
						}
					);
				}
			}

			_hasConfirmationToken(confirmation_token) {
				if(confirmation_token.token) {

					axios.post(API_URL + '/users/confirmation/' + confirmation_token.token)
						.then( res => {

							alert(res.data.message);
							window.location.href = LOGIN_URL;

						}).catch( err => {
							if ( err.response ) {
									alert(err.response.data.message)
							}

						});

				}
			}

		}

		customElements.define(GridApp.is, GridApp);
	</script>
</dom-module>
