<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../../redux/grid-redux-store.html">
<link rel="import" href="../../behaviors/navigation-behavior.html">

<link rel="import" href="components/mobile-header.html">
<link rel="import" href="components/grid-introduction.html">
<link rel="import" href="components/drawer.html">
<link rel="import" href="pages/grid-search.html">
<link rel="import" href="pages/grid-user-post.html">
<link rel="import" href="pages/grid-user-profile.html">
<link rel="import" href="grid-icons.html">
<link rel="import" href="grid-styles.html">

<dom-module id="grid-app">
	<template>

		<style include="grid">
			:host {
				display: block;
				width: 100%;
				height: 100%;
			}

			#drawer {
				--app-drawer-width: 304px;
				--app-drawer-content-container: {
					box-shadow: 1px 0 2px 1px rgba(0, 0, 0, 0.18);
				}
				/*--app-drawer-scrim-background*/
			}

			app-header {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				background-color: #4285f4;
				color: #fff;
			}

			app-header paper-icon-button {
				--paper-icon-button-ink-color: white;
			}

			section .center-page {
				width: 400px;
				height: 600px;
			}

			@media (max-width: 600px) {
				section .center-page {
					width: 100%;
					height: 100%;
				}

				/*iron-pages.pages {
					transition-property: all;
					transition-duration: 200ms;
					transition-property: -webkit-transform;
				  transition-property: transform;
				  -webkit-transform: translate3d(100%, 0, 0);
				  transform: translate3d(100%, 0, 0)
				}

				iron-pages.pages.open {
					-webkit-transform: translate3d(0, 0, 0);
  				transform: translate3d(0, 0, 0);
				}

				iron-pages.pages section {
					height: 100%;
					width: 100%;
				}*/
			}

			#searchFab {
				position: absolute;
				right: 16px;
				bottom: 92px;
			}

			#addFab {
				position: absolute;
				right: 16px;
				bottom: 22px;
			}

			#notificationToast {
				--paper-toast-background-color: var(--red);
				--paper-toast-color: #FFFFFF;
			}
			#notificationToast a {
				text-decoration: none;
			}

			#offline {
				background: var(--red);
				color: #FFFFFF;
				text-align: center;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 20px;
				font-size: 10px;
				line-height: 20px;
				display: none;
			}

			#offline.active {
				display: block;
			}

			.animate {
				transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
				-moz-transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
				-webkit-transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
				-o-transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
				-ms-transition: all 1s cubic-bezier(0.19, 1, 0.22, 1);
			}

			.animate.circle.search {
				/* -webkit-clip-path: circle(28px at 50% 42%);
				clip-path: circle(28px at 50% 42%); */
				clip-path: circle(28px at 408px 583px);
				/* transition-delay: 0.12s; */
			}

			.animate.circle.add {
				clip-path: circle(28px at 408px 653px);
			}

			.animate.circle.search.active,
			.animate.circle.add.active {
				/* -webkit-clip-path: circle(28px ) !important; */
				clip-path: circle(100%) !important;
			}

		</style>

		<!-- <app-location route="{{route}}" use-hash-as-path></app-location> -->
		<app-location route="{{route}}"></app-location>

		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

		<app-route route="{{subroute}}" pattern="/:id" data="{{subrouteData}}"></app-route>

		<app-route route="{{route}}" pattern="/confirmation/:token" data="{{confirmation_token}}"></app-route>

		<app-route route="{{route}}" pattern="/:user/posts/:id" data="{{userPost}}"></app-route>

		<app-route route="{{route}}" pattern="/inbox/:id" data="{{conversation}}"></app-route>

		<grid-map user="[[user]]" map="{{map}}" gmap="{{gmap}}"></grid-map>

		

		<paper-fab id="searchFab" icon="search" class="grid-main-fab" on-tap="redirectSearch"></paper-fab>
		<paper-fab id="addFab" icon="add" class="grid-main-fab" on-tap="redirectPostsAdd"></paper-fab>

		<mobile-header map="{{map}}" gmap="[[gmap]]"></mobile-header>
		
		<grid-introduction is-logged-in="[[isLoggedIn]]"></grid-introduction>

		<iron-pages attr-for-selected="data-page" selected="[[page]]" class="-overlay">

			<section data-page="login" class="overlay">
				<div class="center-page">
					<grid-login id="login" setup-account="{{setupAccount}}"></grid-login>
				</div>
			</section>

			<section data-page="register" class="overlay">
				<div class="center-page">
					<grid-register id="register"></grid-register>
				</div>
			</section>

			<section data-page="forgot" class="overlay">
				<div class="center-page">
					<grid-forgot id="forgot"></grid-forgot>
				</div>
			</section>

			<section data-page="reset-password" class="overlay">
				<div class="center-page">
					<grid-reset-password id="reset-password"></grid-reset-password>
				</div>
			</section>

			<section data-page="profile" class="overlay">
				<div class="center-page">
					<grid-profile id="profile"></grid-profile>
				</div>
			</section>

			<section data-page="user-profile" class="overlay">
				<div class="center-page">
					<grid-user-profile id="user-profile" username="[[username]]"></grid-user-profile>
				</div>
			</section>

			<section data-page="posts" class="overlay">
				<div class="center-page">
					<grid-posts id="posts" map="{{map}}" gmap="[[gmap]]"></grid-posts>
				</div>
			</section>

			<section data-page="bids" class="overlay">
				<div class="center-page">
					<grid-bids id="bids" map="{{map}}" gmap="[[gmap]]"></grid-bids>
				</div>
			</section>

			<section data-page="inbox" class="overlay">
				<div class="center-page">
					<grid-inbox id="inbox" gmap="[[gmap]]"></grid-inbox>
				</div>
			</section>

			<section data-page="search" class="overlay">
				<div class="center-page">
					<grid-search id="search" class="animate circle search" map="{{map}}"></grid-search>
				</div>
			</section>

			<section data-page="user-post" class="overlay">
				<div class="center-page">
					<grid-user-post id="user-post" post-id="[[userPost.id]]" map="{{map}}" gmap="[[gmap]]"></grid-user-post>
				</div>
			</section>

			<section data-page="settings" class="overlay">
				<div class="center-page">
					<grid-settings id="settings" gmap="[[gmap]]" route="[[route]]"></grid-settings>
				</div>
			</section>

			<section data-page="404">
				<grid-404></grid-404>
			</section>

		</iron-pages>

		<app-drawer id="drawer" align="start" swipe-open opened="{{drawerOpened}}">
			<grid-drawer user="user" is-logged-in="[[isLoggedIn]]" notifications="{{notifications}}"></grid-drawer>
		</app-drawer>

		<paper-toast id="notificationToast" vertical-align="top" horizontal-align="right" >
			
		</paper-toast>

		<div id="offline">No internet connection.</div>

	</template>

	<script>
		class GridApp extends 
			GridNavigation(
				ReduxAsyncActionBehavior(
					ReduxBehavior(Polymer.Element))) {

			static get is() { return 'grid-app'; }

			static get properties() {
				return {

					user: {
						type: Object,
						statePath: 'user'
					},

					token: {
						type: Object,
						statePath: 'token'
					},

					auth: {
						type: Boolean,
						statePath: 'auth'
					},

					loaded: {
						type: Boolean,
						value: false,
						reflectToAttribute: true
					},

					app: {
						type: Object,
						value: function () {
							return this;
						},
						notify: true
					},

					skills: {
						type: Object,
						statePath: 'skills'
					},

					allowNotifications: {
						type: Boolean,
						value: false
					}

				}
			}

			static get observers() {
				return [
					'_routeChange(route)',
					'_routeDataChange(routeData)',
					//'_tokenChange(token)',
					'_drawerState(drawerOpened)',
					'_hasConfirmationToken(confirmation_token)',
					'_isAuth(auth)',
					'_setUpNeeded(setupAccount)',
					'_authenticated(token, user)',
					'_pageChange(routeData)',
					'_userPostChange(userPost)'
				]
			}

			_userPostChange(userPost) {
				if( !userPost.user || !userPost.id ) return;
					this.page = 'user-post';
			}

			_pageChange(routeData) {
				if (routeData.page) {
					this.shadowRoot.querySelector('iron-pages').classList.add('open');
				} else {
					this.shadowRoot.querySelector('iron-pages').classList.remove('open');
				}
			}

			constructor() {
				super();
				this._checkLogin();
				this._initSocketEvents();

				window.addEventListener('user:connected', e => {
					
					var user = window.localStorage.getItem('user');

					if(user) {
						window.dispatchEvent( new CustomEvent('user:logged', { detail: JSON.parse(user)}));
					}
				});

				window.addEventListener('online',  () => {
					this.$.offline.classList.remove('active');
					window.dispatchEvent(new CustomEvent('user:connected'));
				});
  			window.addEventListener('offline', () => {
					this.$.offline.classList.add('active');
				});

				moment.updateLocale('en', {
					relativeTime : {
							future: "in %s",
							past:   "%s ago",
							s  : 'just now',
							ss : '%ds',
							m:  "1m",
							mm: "%dm",
							h:  "1h",
							hh: "%dh",
							d:  "1d",
							dd: "%dd",
							M:  "1 month",
							MM: "%d month",
							y:  "1 year",
							yy: "%d year"
					}
				});
			}

			connectedCallback() {
				super.connectedCallback();
				this.loaded = true;
			}

			logout() {
				console.log('logging out');
				this.dispatch('logout');
				this.drawerOpened = false;
				localStorage.removeItem('token');
				localStorage.removeItem('user');
				window.location.href = HOME_URL;
				// this.redirectHome();
			}

			ready() {
				super.ready();
				window.addEventListener('open-drawer', e => {
					this.drawerOpened = true;
				});
			}

			redirectSearch(e) {
				super.redirectSearch();
				const s = this.shadowRoot.querySelector('#search');
				const b = e.target.getBoundingClientRect();
				let top = b.top + 28;
				let left = b.left + 28;
				s.style.clipPath = `circle(28px at ${left}px ${top}px)`;
			}

			redirectPostsAdd(e) {
				super.redirectPostsAdd();
				// const s = this.shadowRoot.querySelector('#posts');
				// const b = e.target.getBoundingClientRect();
				// let top = b.top + 28;
				// let left = b.left + 28;
				// s.style.clipPath = `circle(28px at ${left}px ${top}px)`;
			}

			requestNotificationPermission() {
				Notification.requestPermission().then( result => {
					console.log(result);
					if( result == 'granted') {
						this.allowNotifications = true;
					}
				});
			}

			_checkLogin() {
				const self = this;

				if (checkLogin()) {
					// self.isLoggedIn = true;

					var user = window.localStorage.getItem('user');
					var timeout = 3000;
					if (user) {

						self.dispatch('loggedUser', JSON.parse(user));
						// gAxios.get('/users/' + JSON.parse(user)['id'] + '/skills')
						// .then( res => {
						//   self.dispatch('setSkills', res.data);
						// });
						// window.dispatchEvent( new CustomEvent('user:logged', { detail: JSON.parse(user)}));
						timeout = 100;

						this.requestNotificationPermission();
					}

					// IDEA: Update user after 3 sec
					setTimeout(() => {

						gAxios.get('user')
							.then(res => {

								// IDEA: Update the user local storage
								window.localStorage.setItem('user', JSON.stringify(res.data));

								// IDEA: update the user redux store
								self.dispatch('loggedUser', res.data);

								// socket.emit('user:connect', res.data);

								window.dispatchEvent( new CustomEvent('user:logged', { detail: res.data}));

								if (!res.data.is_account_setup) {
									// redirect(SETUP_URL);
								}

							}).catch(err => {

								if (err.response) {
									console.log('error', err.response);
								}

							});

							this.getNotifications();

					}, timeout);

					// this.set('accountPage', null);
				}
			}

			getNotifications() {
				gAxios.get(`/users/${this.user.id}/notifications`)
				.then( res => {
					this.dispatch('setNotifications', res.data);
				});
			}

			_authenticated(token, user) {
				if (token && user) {
					window.localStorage.clear();
					window.localStorage.setItem('token', token);
					window.localStorage.setItem('user', JSON.stringify(user));
					if (checkLogin()) {
						this.isLoggedIn = true;
					}
				}
			}

			_routeChange(route) {
				if (route.path == '') {
					this.set('routeData.page', null);
				}
			}

			_routeDataChange(routeData) {
				const self = this;
				this.drawerOpened = false;
				if (checkLogin()) {
					switch (routeData.page) {
						case 'login':
						case 'register':
						case 'forgot':
							this.set('routeData.page', null);
							this.redirectHome();
							return;
						case 'logout':
							this.logout();
							return;
					}
				} else {
					switch (routeData.page) {
						case 'profile':
						case 'posts':
						case 'bids':
						case 'inbox':
						case 'transactions':
							this.redirectLogin();
							return;
							break;
						case 'logout':
							this.logout();
							return;
							break;
					}
				}
				if (routeData.page) {

					// IDEA: if profile page
					if (routeData.page.charAt(0) == '@') {
						//console.log('loding user', routeData.page )
						this.page = 'user-profile';
						this.username = routeData.page.substr(1);
						return;
					}

					// IDEA: return if there is no component declared
					try {
						if (!this.shadowRoot.querySelector('#' + routeData.page)) {
							self._showPage404();
							return;
						}
					} catch (e) {
						self._showPage404();
						return;
					}

					this.shadowRoot.querySelector('#' + routeData.page).classList.remove('active');

					Polymer.Base.importHref(
						this.resolveUrl('pages/grid-' + routeData.page + '.html'),
						() => {
							self.page = routeData.page;
							setTimeout(() => {
								this.shadowRoot.querySelector('#' + routeData.page).classList.add('active');
							}, 1);
							
						},
						self._showPage404.bind(self),
						true
					);

				} else {
					self.page = null;
					Polymer.Base.importHref(
						this.resolveUrl('components/grid-map.html'),
						() => {
							// do something after elements has been imported
						}
					);
				}
			}

			_showPage404() {
				this.page = '404';
				Polymer.Base.importHref(
					this.resolveUrl('pages/grid-404.html'),
					() => {
						// do something after elements has been imported
					}
				);
			}

			_drawerState(drawerOpened) {
				const d = this.$.drawer;
				d.opened = drawerOpened;
				// if(drawerOpened) {
				// 	Polymer.Base.importHref(
				// 		'/elements/thegrid/components/drawer.html',
				// 		() => {
				// 			// do something after elements has been imported
				// 		}
				// 	);
				// }
			}

			_hasConfirmationToken(confirmation_token) {
				const self = this;
				if (confirmation_token.token) {

					axios.post(API_URL + '/users/confirmation/' + confirmation_token.token)
						.then(res => {

							// alert(res.data.message);
							// window.location.href = LOGIN_URL;
							self.redirectLogin();

						}).catch(err => {
							if (err.response) {
								alert(err.response.data.message)
							}

						});
				}
			}

			_isAuth(auth) {
				this.isLoggedIn = auth;
			}

			_setUpNeeded(setupAccount) {
				// console.log('setup account', setupAccount);
			}

			_initSocketEvents() {

				const openNotification = (href, text) => {

					if(this.notifications) {
						let $notificationToast = this.$.notificationToast;
						
						$notificationToast.innerHTML = '<a href="' + href + '" class="white" >' + text + '</a>';
						$notificationToast.open();

						var icon = '/assets/images/grid-logo.svg';

						if(this.allowNotifications) {
							var options = {
									body: text,
									icon: icon
							}
							var n = new Notification(text,options);
							n.onclick = function(event) {
								event.preventDefault();
								window.open(href, '_blank');
							}
						}
					}

					this.getNotifications();

				};
				
        // when user receive message
        socket.on('user:receive_message', data => {
					if(!this.auth) return;

					if(this.routeData.page == 'inbox' && this.conversation.id == data.conversation_id) return;
					
					let href = '/inbox/' + data.conversation_id;
					let text = 'New message received';
					openNotification(href, text);
				});
				
				socket.on('user:bidded', data => {
					if(!this.auth) return;
					
					let href = '/posts/' + data.job.id;
					let text = 'A new bidder bids on your job.';
					openNotification(href, text);
				});

				socket.on('user:grant_job', data => {
          if(!this.auth) return;

					if(data.winner_user_id == this.user.id) {
						let href = '/bids/' + data.id;
						let text = 'Your bid has been awarded to you.';
						openNotification(href, text);
					} else {
						let href = '/bids/' + data.id;
						let text = 'Your bidded job has been awarded to other bidder.';
						openNotification(href, text);
					}
        });
				
				socket.on('user:job_in_progress', data => {
					if(!this.auth) return;
					
					console.log('job_in_progress', data);

					if(data.winner_user_id == this.user.id) {
						let href = '/bids/' + data.bid_id;
						let text = 'Your bid has been set to in progress.';
						openNotification(href, text);
					}
				});
				
				socket.on('user:job_review', data => {
					if(!this.auth) return;
					
					console.log('job_review', data);

					if(data.winner_user_id == this.user.id) {
						let href = '/bids/' + data.bid_id;
						let text = 'Your bid has been reviewed.';
						openNotification(href, text);
					}
				});
				
				socket.on('user:job_complete', data => {
					if(!this.auth) return;
					
					console.log('job_complete', data);

					if(data.winner_user_id == this.user.id) {
						let href = '/bids/' + data.bid_id;
						let text = 'Your bid has been completed.';
						openNotification(href, text);
					}
        });

      }

		}

		customElements.define(GridApp.is, GridApp);
	</script>
</dom-module>