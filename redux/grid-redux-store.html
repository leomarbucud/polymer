<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">

<script>



  const API_BASE_URL = (location.hostname == 'dev.thegrid.com') ? 'https://api.thegrid.com' : 'https://dev-thegrid.azurewebsites.net';
  // const API_BASE_URL = 'https://dev.thegrid.com';
  const API_URL = API_BASE_URL + '/api';
  // const APP_URL = 'http://10.0.0.10:8080/#/';
  const APP_URL = '/';
  const HOME_URL = APP_URL;
  const LOGIN_URL = APP_URL + 'login';
  const REGISTER_URL = APP_URL + 'register';
  const FORGOT_URL = APP_URL + 'forgot';
  const PROFILE_URL = APP_URL + 'profile';
  const VERIFY_URL = APP_URL + 'verification';
  const SETUP_URL = APP_URL + 'profile/setup';

  const intialState = {
    user: null,
    token: null,
    auth: false,
    skills: [],
    posts: [],
    bids: [],
    r_markers: null
  };

  const reducer = (state, action) => {
    if( !state ) return intialState;
    switch (action.type) {

      case 'LOGGED_USER': {
        const user = action.user;
        return Object.assign({}, state, { user: user, auth: true } );
        break;
      }
      case 'LOGOUT_USER': {
        return Object.assign({}, state, { user: null, auth: false, token: null, skills: null } );
        break;
      }
      case 'ASSIGN_TOKEN': {
        const token = action.token;
        return Object.assign({}, state, { token: token });
        break;
      }
      case 'GIVE_ACCESS': {
        const _token = action.token;
        const _user = action.user;
        return Object.assign({}, state, { token: _token, user: _user, auth: true });
        break;
      }
      case 'SET_SKILLS': {
        const _skills = action.skills;
        return Object.assign({}, state, { skills: _skills });
        break;
      }
      case 'ADD_SKILL': {
        var skills = state.skills.slice(0);
        skills.push(action.skill);
        return Object.assign({}, state, { skills: skills });
        break;
      }
      case 'REMOVE_SKILL': {
        var skills = state.skills.slice(0);
        skills.splice(skills.indexOf(action.skill), 1);
        return Object.assign({}, state, { skills: skills });
        break;
      }
      case 'SET_POSTS': {
        return Object.assign({}, state, {
          posts: action.posts
        });
        break;
      }
      case 'ADD_POST': {
        let user = JSON.parse(JSON.stringify(state.user));
        let posts = state.posts.slice(0);
        posts.unshift(action.post);
        user.jobs_count += 1;
        return Object.assign({}, state, {
          posts: posts,
          user: user
        });
        break;
      }
      case 'SET_BIDS': {
        return Object.assign({}, state, {
          bids: action.bids
        });
        break;
      }
      case 'ADD_BID': {
        let bids = state.bids.slice(0);
        let user = JSON.parse(JSON.stringify(state.user));
        bids.unshift(action.bid);
        user.bids_count += 1;
        return Object.assign({}, state, {
          bids: bids,
          user: user
        });
        break;
      }
      case 'SET_MARKERS': {
        return Object.assign({}, state, { r_markers: action.markers });
        break;
      }
      case 'ADD_MARKER': {
        var markers = state.r_markers.slice(0);
        console.log(action.marker);
        markers.push(action.marker);
        return Object.assign({}, state, { r_markers: markers });
        break;
      }
    }
  };

  const _store = Redux.createStore(reducer);
  const ReduxBehavior = PolymerRedux(_store);

  window.gAxios = null;

  checkLogin = () => {
    if( localStorage.getItem('token') ) {

      // const access_token = JSON.parse(localStorage.getItem('token'))['access_token'];
      const access_token = localStorage.getItem('token');

      if(access_token) {

        gAxios = axios.create({
          baseURL: API_URL,
          headers: {
            'Authorization': 'Bearer ' + access_token
          }
        });
        return true;
      }
      return false;
    }
    return false;
  }

  checkLogin();

  redirect = url => {
    if( ! url ) return;
    // window.location.href = url;
    window.history.pushState({}, null, url);
    window.dispatchEvent(new CustomEvent('location-changed'));
  }

</script>
