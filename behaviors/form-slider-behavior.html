<link rel="import" href="/bower_components/polymer/polymer.html">
<script>
  const FormSliderBehavior = Polymer.dedupingMixin(function(superClass){
    return class FormSliderBehavior extends superClass {
      constructor() {
        super();
      }

      static get properties() {
        return {

          step: {
            type: Object,
            value: {
              no: 1,
              question: null,
              message: null
            }
          },

          currentStep: {
            type: Number,
            value: 1,
            notify: true
          },

          totalSteps: {
            type: Number,
            notify: true
          },

          formDone: {
            type: Boolean,
            value: false,
            notify: true
          }

        }
      }

      initForm() {

        // IDEA: form mus have form-carousel attribute

        this.stepHeight = 68;
        this.fc = this.shadowRoot.querySelector('[form-carousel]')
        this.fc.style.paddingTop = this.stepHeight + 'px';
        this.steps = this.fc.querySelectorAll('[data-step]');

        this.currentScroll = 0;
        this.currentStep = 1;
        this.startY = 0;
        this._startY = 0;
        this.endY = 0;
        this.totalSteps = this.steps.length;

        this.arrangeSteps(this.currentStep);
        this.inputListenEvents();
        this.touchScrollEvents();
      }

      arrangeSteps(step) {
        const self = this;
        var scroll = 0;
        var step = step;
        this.steps.forEach(function(item) {
          var _step = Number(item.getAttribute('data-step'));
          scroll = self.currentScroll + (Math.abs(step - self.currentStep) * self.stepHeight);
          if(step > self.currentStep) {
            scroll = self.currentScroll + -(Math.abs(step - self.currentStep) * self.stepHeight);
          }

          var translateY = 'translateY(' + scroll + 'px)';

          if ( _step == step) {
            item.style.opacity = 1;
            item.style.transform = 'scaleX(1) ' + translateY;
            item.querySelector('input').removeAttribute('disabled');
            item.querySelector('input').focus();
          } else {
            item.style.opacity = 0.5;
            if( _step > step ) {
              let scale = 1 - ((_step - step) * 0.1);
              item.style.transform = 'scaleX(' + scale + ') ' + translateY;
            } else {
              let scale = 1 - ((step - _step) * 0.1);
              item.style.transform = 'scaleX(' + scale + ') ' + translateY;
            }
            item.querySelector('input').setAttribute('disabled', 'disabled');
          }
        });
        self.currentScroll = scroll;
        self.currentStep = step;

      }

      inputListenEvents() {
        const self = this;

        self.steps.forEach(function(step) {
          const _step = step.getAttribute('data-step');
          const _question = step.getAttribute('data-question');
          var question = _question;

          var focus = function() {

            self.activeStep = _step;
            self.arrangeSteps(_step);

            if( _step == 2 ) {

              question = _question.replace('%name', self.name || '');

            }

            self.set('step.no', _step);
            self.set('step.question', question);

          };

          const click = function() {

            if ( _step > self.currentStep ) {
              if(!self.validate(self.currentStep)) return;
            }

            self.arrangeSteps(_step);

          };

          const keydown = function(e) {

            const kc = e.keyCode;

            if( ((e.shiftKey && kc == 9) || (e.shiftKey && kc == 13)) && self.currentStep != 1 ) {
              e.preventDefault();
              e.stopPropagation();
              self.arrangeSteps(Number(self.currentStep) - 1);
              return;
            }

            if( (kc == 13 || kc == 9) && self.currentStep < self.totalSteps ) {
              e.preventDefault();
              e.stopPropagation();
              if(!self.validate(self.currentStep)) return;
              self.arrangeSteps(Number(self.currentStep) + 1);
              return;
            }

            if( (kc == 13 || kc == 9) && self.currentStep == self.totalSteps ) {
              self.next = true;
              self.formDone = true;
            }

          }

          let input = step.querySelectorAll('input')[0];

          input.addEventListener('focus', focus);
          input.addEventListener('keydown', keydown);

          step.addEventListener('click', click);

        });

      }

      touchScrollEvents() {
        const self = this;
        var handleStart = function(e) {
          self.startY = e.touches[0].clientY;
        }

        var handleMove = function(e) {
          self.endY = e.touches[0].clientY;
          var diff = self.endY - self.startY;
          if(Math.abs(diff) > (self.stepHeight/2)) {
            if ( diff < 0 ) {
              // will not prceed if validation is not satisfied
              if(!self.validate(self.currentStep)) return;

              if( self.currentStep < self.totalSteps)
                self.arrangeSteps(Number(self.currentStep) + 1);
            } else {
              if( self.currentStep != 1)
                self.arrangeSteps(Number(self.currentStep) - 1);
            }
            self.startY = self.endY;
          }
        }

        var wheelMovement = 0;
        var handleWheel = function(e) {
          var deltaY = e.deltaY;
          wheelMovement += deltaY;

          if(Math.abs(wheelMovement) < 50) {
            return;
          }

          var _newStep = Number(self.currentStep) - 1;
          if(wheelMovement > 0) {
            _newStep = Number(self.currentStep) + 1;
            wheelMovement = 0;
            // will not prceed if validation is not satisfied
            if(!self.validate(self.currentStep)) return;
          }

          wheelMovement = 0;
          if(_newStep < 1) {
            self.arrangeSteps(1);
            return;
          }
          if(_newStep > self.totalSteps) {
            self.arrangeSteps(self.totalSteps);
            return;
          }

          self.arrangeSteps(_newStep);
        }

        this.fc.addEventListener("touchstart", handleStart, false);
        this.fc.addEventListener("touchmove", handleMove, false);
        this.fc.addEventListener("wheel", handleWheel, false);

      }

      hasError(element, validate) {
        if(!validate) return false;

        const e = element;
        const val = e.value;
        const validations = validate.split('|');
        var errs = [];
        validations.forEach(function(item) {
          switch (item) {
            case 'required':

              if( val && val != '' && val != null && val != 'undefined' ) {
                // no error
              } else {
                errs.push(item);
              }
              break;

            case 'email':

              let reEmail = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if( ! reEmail.test(val) ) {
                errs.push(item);
              }
              break;

            case 'number':

              let reNum = /^[0-9]+$/;
              if( ! reNum.test(val) ) {
                errs.push(item);
              }
              break;

            case 'match':
              if( val != e.getAttribute('data-match-to') ) {
                errs.push(item);
              }
              break;
          }
        });

        if( errs.length )return errs;

        return false;
      }

      validate(step) {
        var input = this.fc.querySelector('[data-step="' + step + '"]')
                            .querySelector('input');
        let hasError = this.hasError(input, input.getAttribute('data-validate'));
        if( hasError ) {
          this.set('step.message', input.getAttribute('data-message-' + hasError[0]));
          input.focus();
          return false;
        }
        this.set('step.message', null);
        return true;
      }

    }
  });
</script>
