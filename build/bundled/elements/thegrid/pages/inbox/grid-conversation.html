<html><head></head><body><dom-module id="grid-conversation"><template><style include="grid iron-flex">:host{display:block;background:var(--light-grey);height:100%;}main{padding-bottom:76px;}.chat{list-style-type:none;width:100%;padding:0;}.chat:after, .chat-bubble-holder:after, .clear{content:' ';display:block;height:0;clear:both;}.chat-bubble-holder{margin-bottom:8px;min-height:26px;}.chat-bubble{padding:5px 10px;border-radius:10px;max-width:90%;font-size:14px;display:table;}.chat-bubble:after{content:' ';display:block;height:0;clear:both;}.chat-bubble-time{font-size:10px;opacity:0.5;color:#FFFFFF;display:none;padding:8px 0;}.chat-bubble-holder.sent .chat-bubble-time{text-align:right;}.chat-bubble-holder.rcvd .chat-bubble-time{text-align:left;}.chat-bubble-time.show{display:block;}.chat-bubble-time.rcvd{float:left;}.chat-bubble-time.sent{float:right;}.chat-date{clear:both;text-align:center;display:block;padding:8px 0;}.chat-bubble-rcvd{background:#f2f2f2;color:black;float:left;border-bottom-right-radius:10px;}.chat-bubble-sent{background:var(--red);color:white;float:right;border-bottom-left-radius:10px;}.chat-bubble-sent + .chat-bubble-sent{border-top-right-radius:10px;}.chat-bubble-rcvd + .chat-bubble-rcvd{border-top-left-radius:10px;}.chat-bubble-stop{border-bottom-right-radius:10px !important;border-bottom-left-radius:10px !important;}.messages-wrapper{display:flex;align-items:center;justify-content:center;flex-direction:column;min-height:100%;}#message-box{display:flex;align-items:center;justify-content:center;width:100%;position:absolute;bottom:0;left:0;right:0;background:var(--dark-grey);padding:0 16px;}img.circle{width:32px;height:32px;}.conversation-header{display:flex;align-items:center;justify-content:left;}.conversation-header .avatar{position:relative;margin-right:16px;}.typing-indicator-wr{position:absolute;bottom:76px;left:16px;}.typing-indicator{background-color:#f2f2f2;will-change:transform;width:auto;padding:4px;display:table;position:relative;-webkit-animation:2s bulge infinite ease-out;animation:2s bulge infinite ease-out;}.typing-indicator span{height:8px;width:8px;float:left;margin:0 1px;background-color:#9E9EA1;display:block;border-radius:50%;opacity:0.4;}.typing-indicator span:nth-of-type(1){-webkit-animation:1s blink infinite 0.3333s;animation:1s blink infinite 0.3333s;}.typing-indicator span:nth-of-type(2){-webkit-animation:1s blink infinite 0.6666s;animation:1s blink infinite 0.6666s;}.typing-indicator span:nth-of-type(3){-webkit-animation:1s blink infinite 0.9999s;animation:1s blink infinite 0.9999s;}@-webkit-keyframes blink{50%{opacity:1;}}@keyframes blink{50%{opacity:1;}}@-webkit-keyframes bulge{50%{-webkit-transform:scale(1.05);transform:scale(1.05);}}@keyframes bulge{50%{-webkit-transform:scale(1.05);transform:scale(1.05);}}.input-group.suffix .addon-suffix{background-color:var(--dark-grey);}.online-indicator{position:absolute;height:4px;width:4px;background-color:#80ff13;bottom:0;right:0;}</style><div id="toolbar" class="toolbar dgrey-bg shadow"><paper-icon-button icon="chevron-left" class="red pointer" on-click="redirectInbox"></paper-icon-button><div class="flex"><div class="conversation-header"><template is="dom-if" if="[[conversation.messages]]"><div class="avatar"><img class="circle" src$="[[_recipientProfileImage]]"></div><div><span class="name white">[[_getRecipientName]]</span><template is="dom-if" if="[[isUserOnline]]"><small class="white online-indicator-text block">Active</small></template></div></template></div></div></div><main class="scroll-area flex"><section class="messages-wrapper p-y-1"><div class="flex"></div><div id="chat" class="chat" role="list"><template id="messagesTemplate" is="dom-repeat" items="[[conversation.messages]]" as="message" sort="_sort"><template is="dom-if" if="[[message.includeDate]]"><div class="block center chat-date"><small class="white inactive">[[_formatDateTime(message.created_at)]]</small></div></template><div class$="chat-bubble-holder [[message.type]]" id$="chat-[[message.id]]" title="[[message.created_at]]" data-index$="[[index]]" data-author$="[[message.author_id]]" on-click="toggleTime"><span class$="chat-bubble chat-bubble-[[message.type]]"><span>[[message.message]]</span></span><div class="clear"></div><span class="chat-bubble-time">[[_formatDateTime(message.created_at)]]</span></div></template><template is="dom-if" if="[[_hasTmpMessage]]"><template is="dom-repeat" items="[[_tmpMessage]]" as="message"><div class="chat-bubble-holder sent"><span class="chat-bubble chat-bubble-sent"><small hidden$="[[!message.sending]]"><paper-spinner active="" style="width: 12px; height: 12px"></paper-spinner></small><span>[[message.message]]</span></span></div></template></template><template is="dom-if" if="[[isTyping]]"><div class="chat-bubble-holder rcdv"><span class="chat-bubble chat-bubble-rcvd typing"><span class="typing-indicator"><span></span> <span></span> <span></span></span></span></div></template></div></section></main><div id="message-box"><section class="w-100"><form class="form"><div class="input-group suffix dgrey-bg"><input id="message" type="text" class="input dgrey-bg white" autocomplete="off" placeholder="Type a message..." value="{{message::input}}" on-keydown="messageEvent" on-click="readMessage"><div class="addon-suffix has-button dgrey-bg"><paper-icon-button icon="grid:send" class="red" on-tap="send"></paper-icon-button></div></div></form></section></div><template is="dom-if" if="[[isLoading]]"><div class="overlay lgrey-bg" style="margin-top: 64px"><div class="align-center"><paper-spinner active$="[[isLoading]]"></paper-spinner></div></div></template></template><script>class GridConversation extends GridNavigation(ReduxAsyncActionBehavior(ReduxBehavior(Polymer.Element))){static get is(){return'grid-conversation'}static get properties(){return{user:{type:Object,statePath:'user'},auth:{type:Boolean,statePath:'auth'},inbox:{type:Object,statePath:'inbox'},online_users:{type:Array,statePath:'online_users'}}}static get observers(){return['_conversationIdChange(conversationId)','_inboxChange(inbox)','_onlineUsersChange(online_users)']}static get actions(){return{}}constructor(){super(),this.isLoading=!0,this.conversation=null,this._tmpMessage=[],this._hasTmpMessage=!1,this._recipientProfileImage=this._profileImage(null,'Grid'),this.isTyping=!1,this.hasUnread=!1,this._initSocketEvents()}connectedCallback(){super.connectedCallback()}renderConversation(a,b=!0){var d=Math.abs;if(!this.auth)return;let e=null;this.hasUnread=!1,a.messages.map((b,c)=>{if(b.recipient_id==this.user.id&&0==b.status&&(this.hasUnread=!0),b.type=b.author_id==this.user.id?'sent':'rcvd',0==c)return b.includeDate=!0,e=c,b;let f=0;const g=moment(b.created_at).startOf('day'),h=moment(a.messages[e].created_at).startOf('day');f=d(h.diff(g,'days'));const i=moment(new Date).startOf('day');if(0==d(i.diff(g,'days'))){const f=d(moment(a.messages[e].created_at).diff(moment(b.created_at),'minutes')),g=d(moment(a.messages[e].created_at).startOf('hour').diff(moment(b.created_at).startOf('hour'),'hours'));return 1<=g?(b.includeDate=!0,e=c,b):15<=f?(b.includeDate=!0,e=c,b):b}return 0==f?b:(b.includeDate=!0,e=c,b)}),this.conversation=a,this._removeTmpMessage(),this.shadowRoot.querySelector('#messagesTemplate').render(),this.scrollToBottom(b),this.isLoading=!1,this._recipientProfileImage=this._getRecipientProfileImage(),this._getRecipientName=this._getRecipient().name,this._onlineUsersChange(this.online_users),this.hasUnread&&(this.readMessage(),this.hasUnread=!1)}scrollToBottom(a){setTimeout(()=>{const b=this.shadowRoot.querySelector('.messages-wrapper').scrollHeight,c=this.shadowRoot.querySelector('.scroll-area');c.scrollTop=b;let d={top:b,left:0};a&&(d.behavior='smooth'),c.scroll(d)},50)}send(){if(this.auth&&this.message){var a={id:'tmpMessage',message:this.message,created_at:new Date().getTime(),sending:!0};this._createTmpMessage(a);const b=this.message;this.message='',gAxios.post('/users/'+this.user.id+'/conversations/'+this.conversationId,{message:b,recipient_id:this._getRecipientId()}).then((a)=>{var b=a.data;this.dispatch('addMessage',b.conversation_id,b),window.dispatchEvent(new CustomEvent('user:send_message',{detail:b}))}).catch(()=>{}).then(()=>{})}}messageEvent(a){this;return 13==a.keyCode?(this.send(),void a.preventDefault()):void(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{window.dispatchEvent(new CustomEvent('user:typing',{detail:{recipient_id:this._getRecipientId(),conversation_id:this.conversationId}}))},200))}readMessage(){this.auth&&this.hasUnread&&gAxios.post(`/users/${this.user.id}/conversations/${this.conversationId}/read`).then((a)=>{this.hasUnread=!1,this.dispatch('updateConversation',this.conversationId,a.data)}).catch(()=>{})}toggleTime(a){const b=a.model.message.id,c=this.shadowRoot.querySelector(`#chat-${b}`);if(c){const a=c.querySelector('.chat-bubble-time');a.classList.contains('show')?a.classList.remove('show'):a.classList.add('show')}}_removeTmpMessage(){this.set('_tmpMessage',[]),this._hasTmpMessage=!1}_getRecipientId(){return this.conversation.user_id_1==this.user.id?this.conversation.user_id_2:this.conversation.user_id_1}_getRecipient(){return this.conversation.user1.id==this._getRecipientId()?this.conversation.user1:this.conversation.user2}_getRecipientProfileImage(){const a=this._getRecipient();return a.profile&&a.profile.profile_image_url?this._profileImage(a.profile.profile_image_url,a.name):this._profileImage(null,a.name)}_conversationIdChange(a){return a?void(!this.auth||(this.isLoading=!0,this.inbox.map((b)=>{parseInt(b.id)===parseInt(a)&&(this.renderConversation(b,!1),this.isLoading=!1)}))):void(this.conversation=[])}_createTmpMessage(a){this._hasTmpMessage=!0,this.push('_tmpMessage',a),this.scrollToBottom(!0)}_inboxChange(){this.inbox.map((a)=>{parseInt(a.id)===parseInt(this.conversationId)&&(this.renderConversation(a),this.isLoading=!1)})}_getMessageStatus(a){return a}_sort(c,a){return c=new Date(c.created_at),a=new Date(a.created_at),a>c?-1:a<c?1:0}_getClass(a){return this.user.id==a?'chat-bubble-sent':'chat-bubble-rcvd'}_sameAsDateBefore(a,b){if(0==b)return!1;const c=moment(a,'YYYY-MM-DD');let d=0;const e=this.$.chat.querySelector('li[data-index="'+(b-1)+'"]');if(e){const a=moment(e.getAttribute('title'),'YYYY-MM-DD');d=Math.abs(a.diff(c,'days'))}return!(0!==d)}_formatDateTime(a){const b=moment(new Date).startOf('day'),c=moment(a).startOf('day'),d=b.diff(c,'days');return 0==d?`${moment(a).format('HH:mm')}`:1==d?`Yesterday - ${moment(a).format('HH:mm')}`:7<=d?moment(a).format('MMM D [-] HH:mm'):moment(a).format('ddd [-] HH:mm')}_profileImage(a,b){return a?this.url.API_BASE_URL+'/uploads/'+a:LetterAvatar(b,'32')}_details(a){return a?a:'No details provided.'}_onlineUsersChange(a){a&&a.length&&this.conversation&&(-1==a.indexOf(this._getRecipientId())?this.isUserOnline=!1:this.isUserOnline=!0)}_initSocketEvents(){socket.on('user:receive_message',()=>{this.auth&&(this.isTyping=!1)});var a;socket.on('user:typing',(b)=>{b&&(b.conversation_id!=this.conversationId||(this.isTyping=!0,this.scrollToBottom(),a&&clearTimeout(a),a=setTimeout(()=>{this.isTyping=!1},8e3)))})}}customElements.define(GridConversation.is,GridConversation);</script></dom-module></body></html>