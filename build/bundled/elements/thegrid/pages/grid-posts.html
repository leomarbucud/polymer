<html><head></head><body><div hidden="" by-polymer-bundler=""><link rel="import" href="posts/grid-post.html"></div><dom-module id="grid-posts"><template><style include="grid grid-cards iron-flex">:host{display:block;position:relative;height:100%;background:var(--light-grey);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-direction:column;-webkit-flex-direction:column;flex-direction:column;}.title h1{font-weight:400;font-size:32px;}.row{color:#FFFFFF;padding:8px 16px;position:relative;cursor:pointer;}.row .job-title{line-height:24px;font-size:18px;}.row [secondary]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.7;}.divider{padding:0 16px;}.divider hr{margin:0;opacity:0.12;}.time{font-size:12px;opacity:0.7;}paper-item.iron-selected{background-color:#484848;}</style><app-location route="{{route}}"></app-location><app-route route="{{route}}" pattern="/posts" data="{{routeData}}" tail="{{subroute}}"></app-route><app-route route="{{subroute}}" pattern="/:id" data="{{subrouteData}}"></app-route><app-route route="{{route}}" pattern="/posts/:id" data="{{post}}"></app-route><app-route route="{{route}}" pattern="/posts/edit/:id" data="{{postEdit}}"></app-route><div id="toolbar" class="toolbar"><paper-icon-button icon="first-page" class="red pointer" on-click="redirectHome"></paper-icon-button><div class="flex" style="overflow: hidden"><span id="toolbar-title">Posts</span></div><paper-icon-button icon="search" class="red pointer" on-click="openSearchBar"></paper-icon-button><paper-menu-button horizontal-align="right" vertical-align="top" ignore-select="true"><paper-icon-button icon="more-vert" slot="dropdown-trigger" class="red"></paper-icon-button><paper-listbox slot="dropdown-content" class="dropdown-menu"><paper-item class="item" on-click="refreshJobs"><span>Refresh</span></paper-item><paper-item class="item-title"><span>Show only</span></paper-item><paper-item class="item"><paper-checkbox value="nobidders" on-change="filterCheck">No bidders</paper-checkbox></paper-item><paper-item class="item"><paper-checkbox value="bidded" on-change="filterCheck">Bidded</paper-checkbox></paper-item><paper-item class="item"><paper-checkbox value="1" on-change="filterCheck">Awarded</paper-checkbox></paper-item><paper-item class="item"><paper-checkbox value="2" on-change="filterCheck">In progress</paper-checkbox></paper-item><paper-item class="item"><paper-checkbox value="4" on-change="filterCheck">Completed</paper-checkbox></paper-item></paper-listbox></paper-menu-button></div><div class="top-search-bar"><div class="toolbar"><div class="input-group suffix prefix"><div class="addon-prefix has-button"><paper-icon-button icon="chevron-left" class="pointer" on-click="closeSearchBar"></paper-icon-button></div><input type="text" class="input" value="{{search::input}}" placeholder="Search..."><div class="addon-suffix has-button"><paper-icon-button icon="close" class="pointer" on-click="clearSearchBar"></paper-icon-button></div></div></div></div><main class="flex relative"><section class="p-y-1 title"><h1 id="main-title" class="white m-0">Posts</h1></section><div id="post-list" class="white p-y-1" role="listbox"><template is="dom-repeat" items="[[posts]]" as="job" filter="{{_filterPosts(query)}}"><paper-card class="card-list" id$="[[job.id]]"><div class="layout horizontal w-100"><div class="card-content" on-click="viewPost"><div class="header-date">[[ _getStatus(job) ]]</div><div class="header-title">[[job.name]]</div><div class="description">[[job.details]]</div></div><paper-menu-button horizontal-align="right" vertical-align="top"><paper-icon-button icon="more-vert" slot="dropdown-trigger"></paper-icon-button><paper-listbox slot="dropdown-content" class="dropdown-menu"><template is="dom-if" if="[[ !job.is_accepted ]]"><paper-item class="item" on-click="editPost"><span>Edit</span></paper-item><paper-item class="item" on-click="openDeletePostDialog"><span>Remove</span></paper-item></template><template is="dom-if" if="[[ !job.is_completed ]]"><template is="dom-if" if="[[ job.is_accepted ]]"><paper-item class="item" on-click="openDeletePostDialog"><span>Cancel</span></paper-item></template></template><template is="dom-if" if="[[ job.completed ]]"><paper-item class="item" on-click="openDeletePostDialog"><span>Remove</span></paper-item></template></paper-listbox></paper-menu-button></div></paper-card></template><template is="dom-if" if="[[!posts.length]]"><div class="overlay"><div class="align-center"><p>You don't have any posts</p></div></div></template></div></main><iron-pages id="subPages" attr-for-selected="data-page" selected="[[subPage]]"><section data-page="edit" class="sub-page"><grid-posts-edit id="posts-edit" post-id="[[postEdit.id]]" gmap="[[gmap]]"></grid-posts-edit></section><section data-page="post" class="sub-page"><grid-post gmap="[[gmap]]" post="[[_post]]" post-id="[[post.id]]"></grid-post></section></iron-pages><template is="dom-if" if="[[isLoading]]"><div class="overlay lgrey-bg" style="margin-top: 64px"><div class="align-center"><paper-spinner active$="[[isLoading]]"></paper-spinner></div></div></template><paper-dialog id="deleteDialog" class="dialog-dark"><h2>Remove Post?</h2><div><p>Removing this post is permanent. Any bidding in progress will be lost.</p></div><div class="buttons"><paper-button dialog-dismiss="" autofocus="">No</paper-button><paper-button dialog-confirm="" on-tap="deletePost">Yes</paper-button></div></paper-dialog><paper-toast id="deleteToast" duration="3000" class="fit-bottom" text="Post deleted."></paper-toast></template><script>class GridPosts extends GridNavigation(ReduxAsyncActionBehavior(ReduxBehavior(Polymer.Element))){static get is(){return'grid-posts'}static get properties(){return{user:{type:Object,statePath:'user'},auth:{type:Boolean,statePath:'auth'},posts:{type:Array,statePath:'posts'},map:{type:Object,notify:!0},isLoading:{type:Boolean,value:!0},query:{type:Array,value:[]},search:String}}static get observers(){return['_subrouteChange(subroute)','_subrouteDataChange(subrouteData)','_postChange(post)','_search(search)']}_postChange(){const a=this.shadowRoot.querySelector('#post-list');this.iterval&&clearInterval(this.interval),this.interval=setInterval(()=>{var b=a.querySelectorAll('[data-time]');b.forEach((a)=>{let b=a.getAttribute('data-time');a.innerHTML=this._fromNow(b)})},3e4)}static get actions(){return{}}constructor(){super(),this._initSocketEvents(),window.addEventListener('user:connected',()=>{this.populateJobs()})}connectedCallback(){super.connectedCallback(),this.populateJobs(),this.headerAnimate(),setInterval(()=>{const a=this.shadowRoot.querySelectorAll('[data-time]');a&&a.forEach((a)=>{let b=a.dataset.time;a.textContent=this._fromNow(b)})},1e3)}headerAnimate(){const a=this.shadowRoot.querySelector('#toolbar'),b=this.shadowRoot.querySelector('main'),c=this.shadowRoot.querySelector('#toolbar-title'),d=this.shadowRoot.querySelector('#main-title'),e=16;let f=0,g=0;const h=()=>{const a=c.offsetHeight,b=d.offsetHeight;if(g>=e&&g<=e+b){f=g-e;let d=a-f*(a/b);c.style.cssText=`transform: translateY(${d}px); transition-duration: 0ms`}g>=e+b&&(c.style.transform=`translateY(0)`,c.style.transitionDuration=`100ms`),g<=e&&(c.style.transform=`translateY(${a}px)`,c.style.transitionDuration=`100ms`)};b.addEventListener('scroll',()=>{let c=b.scrollTop;0<c?a.classList.add('shadow'):a.classList.remove('shadow'),g=c,requestAnimationFrame(h)})}populateJobs(){if(!this.user)return;const a=(a)=>{this.pagination={total:a.total,per_page:a.per_page,current_page:a.current_page,last_page:a.last_page,next_page_url:a.next_page_url,prev_page_url:a.prev_page_url,from:a.from,to:a.to},this.isLoading=!1,this.dispatch('setPosts',a.data)},b=`/users/${this.user.id}/jobs`,c=(()=>gAxios.get(b,{headers:{}}).catch(function(){return null}))().then((b)=>!!b&&!!b.data&&(a(b.data),!0)),d=(()=>'serviceWorker'in navigator&&navigator.serviceWorker.controller?gAxios.get(b,{headers:{Cached:'yes'}}).catch(function(){return null}):Promise.resolve(null))().then((b)=>!!b&&!!b.data&&(a(b.data),!0));c.then((a)=>a||d).then((a)=>{!a,this.isLoading=!1})}viewPost(a){const b=a.model.job.id;this.redirect(`/posts/${b}`),this._post=a.model.job}editPost(a){const b=a.model.job.id;this.redirect(`/posts/edit/${b}/#1`),this._post=a.model.job}openDeletePostDialog(a){const b=this.shadowRoot.querySelector('#deleteDialog');b.open(),this.post_to_delete=a.model.job}deletePost(){this.post_to_delete&&(this.isLoading=!0,gAxios.post(`/users/${this.user.id}/jobs/${this.post_to_delete.id}/delete`).then(()=>{const a=this.shadowRoot.querySelector('#deleteToast');a.open(),this.dispatch('removePost',this.post_to_delete),this.gmap&&this.gmap.removePostById(this.post_to_delete.id)}).catch(()=>{}).then(()=>{this.isLoading=!1}))}openMenu(){this.$.menu.open()}refreshJobs(){this.populateJobs()}filterCheck(a){const b=a.target;if(b.checked)this.push('query',b.value);else{const a=this.query.indexOf(b.value);-1!=a&&this.query.splice(a,1)}const c=this.query.slice(0);this.set('query',c)}openSearchBar(){const a=this.shadowRoot.querySelector('.top-search-bar');a.classList.add('active'),a.querySelector('input').focus()}closeSearchBar(){this.shadowRoot.querySelector('.top-search-bar').classList.remove('active')}clearSearchBar(){this.search='';const a=this.shadowRoot.querySelector('.top-search-bar');a.querySelector('input').focus()}_search(b){let c=this.query.slice(0);b||(c.search=null),b&&(c.search=b),this.set('query',c)}_filterPosts(a){this;return a.length||a.search?function(b){if(a.search){let c=a.search.toLowerCase(),d=b.name.toLowerCase();if(-1==d.indexOf(c))return!1}return!a.length||(0==b.status?-1!=a.indexOf('bidded')&&-1!=a.indexOf('nobidders')||(-1==a.indexOf('bidded')?-1==a.indexOf('nobidders')?null:0==b.bidders.length:0<b.bidders.length):-1!=a.indexOf(b.status.toString()))}:null}_fromNow(a){return moment(a).fromNow()}_subrouteChange(a){''==a.path&&(this.set('subrouteData.id',null),this.subPage=null)}_subrouteDataChange(a){const b=this;a.id?this.shadowRoot.querySelector(`#posts-${a.id}`)?Polymer.Base.importHref(`/elements/thegrid/pages/posts/grid-posts-${a.id}.html?v=${window.VERSION}`,()=>{b.subPage=a.id}):b.subPage='post':b.subPage=null}_initSocketEvents(){socket.on('user:posted',(a)=>{const b=a;this.auth&&b.user.id==this.user.id&&this.dispatch('addPost',b)}),socket.on('user:bidded',(a)=>{const b=a;this.auth&&b.job.user.id==this.user.id&&(console.log('updating post'),gAxios.get('/users/'+this.user.id+'/jobs/'+b.job.id).then((a)=>{const b=a.data;window.dispatchEvent(new CustomEvent('user:other_bidded',{detail:b.bidders})),this.dispatch('updatePost',b)}).then(()=>{this.isLoading=!1}))}),socket.on('bidder:job_in_progress',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.job_id}`).then((a)=>{this.dispatch('updatePost',a.data)})}),socket.on('bidder:job_complete',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.job_id}`).then((a)=>{this.dispatch('updatePost',a.data)})}),socket.on('bidder:accept_job',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.id}`).then((a)=>{this.dispatch('updatePost',a.data)})}),socket.on('bidder:decline_job',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.id}`).then((a)=>{this.dispatch('updatePost',a.data)})}),socket.on('user:like_query',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.id}`).then((a)=>{this.dispatch('updatePost',a.data)}).then(()=>{this.isLoading=!1})}),socket.on('user:dislike_query',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.id}`).then((a)=>{this.dispatch('updatePost',a.data)}).then(()=>{this.isLoading=!1})}),socket.on('user:add_query',(a)=>{this.auth&&gAxios.get(`/users/${this.user.id}/jobs/${a.id}`).then((a)=>{this.dispatch('updatePost',a.data)}).then(()=>{this.isLoading=!1})})}_getStatus(a){return a.is_completed?`Completed ${this._fromNow(a.updated_at)}`:a.is_moving?`In Progress ${this._fromNow(a.updated_at)}`:a.is_awarded?`Awarded ${this._fromNow(a.updated_at)}`:`Posted ${this._fromNow(a.created_at)}`}}customElements.define(GridPosts.is,GridPosts);</script></dom-module></body></html>