<html><head></head><body><div hidden="" by-polymer-bundler=""><dom-module id="paper-badge" assetpath="../../../bower_components/paper-badge/"><template><style>:host{display:block;position:absolute;outline:none;}:host([hidden]), [hidden]{display:none !important;}iron-icon{--iron-icon-width:12px;--iron-icon-height:12px;}.badge{@apply --layout;@apply --layout-center-center;@apply --paper-font-common-base;font-weight:normal;font-size:11px;border-radius:50%;margin-left:var(--paper-badge-margin-left, 0px);margin-bottom:var(--paper-badge-margin-bottom, 0px);width:var(--paper-badge-width, 20px);height:var(--paper-badge-height, 20px);background-color:var(--paper-badge-background, var(--accent-color));opacity:var(--paper-badge-opacity, 1.0);color:var(--paper-badge-text-color, white);@apply --paper-badge;}</style><div class="badge"><iron-icon hidden$="{{!_computeIsIconBadge(icon)}}" icon="{{icon}}"></iron-icon><span id="badge-text" hidden$="{{_computeIsIconBadge(icon)}}">{{label}}</span></div></template><script>Polymer({is:'paper-badge',hostAttributes:{role:'status',tabindex:0},behaviors:[Polymer.IronResizableBehavior],listeners:{"iron-resize":'updatePosition'},properties:{for:{type:String,observer:'_forChanged'},label:{type:String,observer:'_labelChanged'},icon:{type:String,value:''},_boundNotifyResize:{type:Function,value:function(){return this.notifyResize.bind(this)}},_boundUpdateTarget:{type:Function,value:function(){return this._updateTarget.bind(this)}}},attached:function(){requestAnimationFrame(this._boundUpdateTarget)},attributeChanged:function(a){'hidden'===a&&this.updatePosition()},_forChanged:function(){this.isAttached&&this._updateTarget()},_labelChanged:function(){this.setAttribute('aria-label',this.label)},_updateTarget:function(){this._target=this.target,requestAnimationFrame(this._boundNotifyResize)},_computeIsIconBadge:function(a){return 0<a.length},get target(){var a,b=Polymer.dom(this).parentNode,c=Polymer.dom(this).getOwnerRoot();return a=this.for?Polymer.dom(c).querySelector('#'+this.for):b.nodeType==Node.DOCUMENT_FRAGMENT_NODE?c.host:b,a},updatePosition:function(){if(this._target&&this.offsetParent){var a=this.offsetParent.getBoundingClientRect(),b=this._target.getBoundingClientRect(),c=this.getBoundingClientRect();this.style.left=b.left-a.left+(b.width-c.width/2)+'px',this.style.top=b.top-a.top-c.height/2+'px'}}});</script></dom-module><link rel="import" href="inbox/grid-conversation.html"></div><dom-module id="grid-inbox"><template><style include="grid iron-flex">:host{display:block;position:relative;height:100%;background:var(--light-grey);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-direction:column;-webkit-flex-direction:column;flex-direction:column;}.title h1{font-weight:400;font-size:32px;}.row{color:#FFFFFF;padding:8px 16px;position:relative;cursor:pointer;}.row .job-title{line-height:24px;font-size:18px;}.row [secondary]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0.7;}.divider{padding:0 16px;}.divider hr{margin:0;opacity:0.12;}.badge.unread{background:var(--red);font-size:9px;min-width:16px;height:16px;display:block;text-align:center;line-height:16px;border-radius:50%;color:#FFFFFF;float:right;}.time{font-size:12px;opacity:0.7;}.avatar{width:40px;height:40px;display:block;}.avatar .circle{width:40px;height:40px;}.red{--paper-badge-background:var(--red);}paper-icon-item.iron-selected{background-color:#484848;}</style><app-location route="{{route}}"></app-location><app-route route="{{route}}" pattern="/inbox" data="{{routeData}}" tail="{{subroute}}"></app-route><app-route route="{{subroute}}" pattern="/:id" data="{{subrouteData}}"></app-route><app-route route="{{route}}" pattern="/inbox/:id" data="{{conversation}}"></app-route><div id="toolbar" class="toolbar"><paper-icon-button icon="first-page" class="red pointer" on-click="redirectHome"></paper-icon-button><div class="flex" style="overflow: hidden"><span id="toolbar-title">Inbox</span></div><paper-icon-button icon="search" class="red pointer" on-click="openSearchBar"></paper-icon-button><paper-menu-button horizontal-align="right" vertical-align="top" ignore-select="true"><paper-icon-button icon="more-vert" slot="dropdown-trigger" class="red"></paper-icon-button><div slot="dropdown-content" class="dropdown-menu"><div class="item" on-click="refreshInbox"><span>Refresh</span><paper-ripple></paper-ripple></div><div class="item-title"><span>Show only</span></div><div class="item"><paper-checkbox value="1" on-change="filterCheck">Awarded</paper-checkbox></div><div class="item"><paper-checkbox value="2" on-change="filterCheck">In progress</paper-checkbox></div><div class="item"><paper-checkbox value="3" on-change="filterCheck">Review</paper-checkbox></div><div class="item"><paper-checkbox value="4" on-change="filterCheck">Completed</paper-checkbox></div></div></paper-menu-button></div><div class="top-search-bar"><div class="toolbar"><div class="input-group suffix prefix"><div class="addon-prefix has-button"><paper-icon-button icon="chevron-left" class="pointer" on-click="closeSearchBar"></paper-icon-button></div><input type="text" class="input" value="{{search::input}}" placeholder="Search..."><div class="addon-suffix has-button"><paper-icon-button icon="close" class="pointer" on-click="clearSearchBar"></paper-icon-button></div></div></div></div><main class="flex relative"><section class="p-y-1 title"><h1 id="main-title" class="white m-0">Inbox</h1></section><div class="white" role="listbox"><iron-selector id="inbox-selector" attr-for-selected="id" selected="{{conversation.id}}"><template id="inboxList" is="dom-repeat" items="[[conversations]]" as="convo" sort="_sortByUpdatedAt" filter="{{_filterInbox(query)}}"><paper-icon-item id$="{{convo.id}}" on-click="viewConversation"><div class="avatar" slot="item-icon"><img class="circle" src$="[[_otherUserProfileImage(convo.user1, convo.user2)]]"></div><paper-item-body two-line=""><div>[[convo.job.name]]</div><div secondary="">[[_lastMesage(convo.messages, convo.user1, convo.user2)]]</div></paper-item-body><div class="layout vertical-reverse"><div class="time" data-time$="[[convo.updated_at]]">[[_fromNow(convo.updated_at)]]</div><template is="dom-if" if="[[_lastRecipient(convo.last_updated_by, convo.unread_count)]]"><span class="badge unread">[[convo.unread_count]]</span></template></div></paper-icon-item></template></iron-selector><template is="dom-if" if="[[!conversations.length]]"><div class="overlay"><div class="align-center"><p>You don't have any conversation</p></div></div></template></div></main><iron-pages id="subPages" attr-for-selected="data-page" selected="[[subPage]]"><section data-page="conversation" class="sub-page"><grid-conversation conversation-id="[[conversation.id]]" gmap="[[gmap]]"></grid-conversation></section></iron-pages><template is="dom-if" if="[[isLoading]]"><div class="overlay lgrey-bg" style="margin-top: 64px"><div class="align-center"><paper-spinner active$="[[isLoading]]"></paper-spinner></div></div></template></template><script>class GridInbox extends GridNavigation(ReduxAsyncActionBehavior(ReduxBehavior(Polymer.Element))){static get is(){return'grid-inbox'}static get properties(){return{user:{type:Object,statePath:'user'},auth:{type:Boolean,statePath:'auth'},inbox:{type:Array,statePath:'inbox'},isLoading:{type:Boolean,value:!1},query:{type:Array,value:[]}}}static get observers(){return['_subrouteChange(subroute)','_subrouteDataChange(subrouteData)','_inboxChange(inbox)','_search(search)']}static get actions(){return{}}constructor(){super(),this._initSocketEvents(),window.addEventListener('user:connected',()=>{this.populateInbox()})}connectedCallback(){super.connectedCallback(),this.populateInbox(),this.headerAnimate(),setInterval(()=>{const a=this.shadowRoot.querySelectorAll('[data-time]');a&&a.forEach((a)=>{let b=a.dataset.time;a.textContent=this._fromNow(b)})},1e3)}headerAnimate(){const a=this.shadowRoot.querySelector('#toolbar'),b=this.shadowRoot.querySelector('main'),c=this.shadowRoot.querySelector('#toolbar-title'),d=this.shadowRoot.querySelector('#main-title'),e=16;let f=0,g=0;const h=()=>{const a=c.offsetHeight,b=d.offsetHeight;if(g>=e&&g<=e+b){f=g-e;let d=a-f*(a/b);c.style.cssText=`transform: translateY(${d}px); transition-duration: 0ms`}g>=e+b&&(c.style.transform=`translateY(0)`,c.style.transitionDuration=`100ms`),g<=e&&(c.style.transform=`translateY(${a}px)`,c.style.transitionDuration=`100ms`)};b.addEventListener('scroll',()=>{let c=b.scrollTop;0<c?a.classList.add('shadow'):a.classList.remove('shadow'),g=c,requestAnimationFrame(h)})}populateInbox(){if(!this.user)return;this.isLoading=!0;const a=(a)=>{this.pagination={total:a.total,per_page:a.per_page,current_page:a.current_page,last_page:a.last_page,next_page_url:a.next_page_url,prev_page_url:a.prev_page_url,from:a.from,to:a.to},this.isLoading=!1,this.dispatch('setInbox',a.data)},b=`/users/${this.user.id}/inbox`,c=(()=>gAxios.get(b,{headers:{}}).catch(function(){return null}))().then((b)=>!!b&&!!b.data&&(a(b.data),!0)),d=(()=>'serviceWorker'in navigator&&navigator.serviceWorker.controller?gAxios.get(b,{headers:{Cached:'yes'}}).catch(function(){return null}):Promise.resolve(null))().then((b)=>!!b&&!!b.data&&(a(b.data),!0));c.then((a)=>a||d).then((a)=>{!a,this.isLoading=!1})}refreshInbox(){this.populateInbox()}viewConversation(a){const b=a.model.convo.id;this.redirect('/inbox/'+b)}openSearchBar(){const a=this.shadowRoot.querySelector('.top-search-bar');a.classList.add('active'),a.querySelector('input').focus()}closeSearchBar(){this.shadowRoot.querySelector('.top-search-bar').classList.remove('active')}clearSearchBar(){this.search='';const a=this.shadowRoot.querySelector('.top-search-bar');a.querySelector('input').focus()}_search(b){let c=this.query.slice(0);b||(c.search=null),b&&(c.search=b),this.set('query',c)}filterCheck(a){const b=a.target;if(b.checked)this.push('query',b.value);else{const a=this.query.indexOf(b.value);-1!=a&&this.query.splice(a,1)}const c=this.query.slice(0);this.set('query',c)}_filterInbox(a){this;return a.length||a.search?function(b){if(a.search){let c=a.search.toLowerCase(),d=b.job.name.toLowerCase();if(-1==d.indexOf(c))return!1}return!a.length||-1!=a.indexOf(b.job.status.toString())}:null}openMenu(){this.$.menu.open()}refreshJobs(){this.populateJobs()}renderInbox(a){if(a){const c=a.slice(0);this.conversations=c,this.totalUnread=0;for(var b=0;b<c.length;b++)this.notifyPath(`conversations.${b}.unread_count`,c[b].unread_count),this.notifyPath(`conversations.${b}.updated_at`,c[b].updated_at),this.notifyPath(`conversations.${b}.messages`,c[b].messages),this.notifyPath(`conversations.${b}.id`,c[b].id),this._lastRecipient(c[b].last_updated_by,c[b].unread_count)&&(this.totalUnread+=+c[b].unread_count);this.dispatch('setUnreadMessages',this.totalUnread)}}_inboxChange(a){this.renderInbox(a)}_lastRecipient(a,b){return this.auth?this.user.id!=a&&0<b:void 0}_otherUserProfileImage(a,b){let c=a.name,d=null;return a.id==this.user.id?(c=b.name,b.profile&&(d=b.profile.profile_image_url)):a.profile&&(d=a.profile.profile_image_url),this._profileImage(d,c)}_lastMesage(a,b,c){if(!a.length)return'Start a conversation...';var d='You: ',e=a[a.length-1].message;return a[a.length-1].author_id!=this.user.id&&(this.user.id==b.id?d=`${c.name}: `:d=`${b.name}: `),d+e}_fromNow(a){const b=moment(new Date).startOf('day'),c=moment(a).startOf('day'),d=b.diff(c,'days');return 0==d?`${moment(a).format('HH:mm')}`:1==d?`Yesterday`:7<=d?moment(a).format('MMM D'):moment(a).format('ddd')}_subrouteChange(a){''==a.path&&(this.set('subrouteData.id',null),this.subPage=null,this.set('conversation.id',0))}_subrouteDataChange(a){const b=this;a.id?this.shadowRoot.querySelector('#posts-'+a.id)?Polymer.Base.importHref(`/elements/thegrid/pages/inbox/grid-inbox-${a.id}.html?v=${window.VERSION}`,()=>{b.subPage=a.id}):b.subPage='conversation':b.subPage=null}_sortByUpdatedAt(c,a){return c=new Date(c.updated_at),a=new Date(a.updated_at),a<c?-1:a>c?1:0}_profileImage(a,b){return a?this.url.API_BASE_URL+'/uploads/'+a:LetterAvatar(b,64)}_initSocketEvents(){socket.on('user:receive_message',(a)=>{this.auth&&(console.log('user receive',a),this.dispatch('addMessage',a.conversation_id,a))}),socket.on('user:sent_message',()=>{!this.auth}),socket.on('user:create_conversation',(a)=>{this.auth&&this.dispatch('addInbox',a)})}}customElements.define(GridInbox.is,GridInbox);</script></dom-module></body></html>