<html><head></head><body><dom-module id="grid-map"><template><style include="grid iron-flex">:host{display:block;width:100%;height:100%;padding-top:47px;}:host(.selecting){position:absolute;top:0;right:0;bottom:0;left:0;z-index:98;}#mapCanvas{height:100%;width:100%;background-color:#2b2b2b;}.gmnoprint:not(.gm-bundled-control), .gmnoscreen{display:none;}.gm-bundled-control .gmnoprint{display:block;}#searchResultToast paper-button{text-transform:none;}.clear-search, .clear-filter{position:absolute;bottom:22px;width:100px;text-align:center;right:calc(50% - 50px);cursor:pointer;display:none;}.clear-search.show, .clear-filter.show{display:block;}#locationError{position:absolute;top:0;left:0;right:0;bottom:0;padding:32px;text-align:center;display:none;justify-content:center;align-items:center;color:#FFFFFF;background-color:var(--light-grey);}#locationError.show{display:flex;}</style><div id="mapCanvas"><div class="overlay" style="background: #212121"><div class="align-center"><paper-spinner active=""></paper-spinner></div></div></div><div id="clearSearch" class="clear-search"><span class="red" on-click="closeClearSearch">Clear Search</span></div><div id="clearFilter" class="clear-filter"><span class="red" on-click="closeClearFilter">Clear Filter</span></div><div id="locationError"><h1>This app requires your location.</h1></div></template><script>class GridMap extends GridNavigation(MapBehaviorMixin(ReduxBehavior(Polymer.Element))){static get is(){return'grid-map'}static get properties(){return{apiKey:{type:String,value:'AIzaSyAJyuWvZ03O18yHTvC1t3Mlj22VY73hJWc'},user:{type:Object,statePath:'user'},auth:{type:Boolean,statePath:'auth'},cluster:{type:Boolean,value:!0},r_markers:{type:Object,statePath:'r_markers'},gmap:{type:Object,value:function(){return this},notify:!0},locationPermission:{type:Boolean,notify:!0}}}static get observers(){return['_authChange(auth)']}static get actions(){return{setMarkers(a){return{type:'SET_MARKERS',markers:a}},r_addMarker(a){return{type:'ADD_MARKER',marker:a}}}}get searchResultToast(){return this.shadowRoot.querySelector('#searchResultToast')}constructor(){super();this;this._initSocketEvents(),window.addEventListener('user:connected',()=>{this.locationPermission&&this.populateJobMarkers()}),window.addEventListener('offline',()=>{this.loadingJobMarkers=!1}),window.addEventListener('filter',(a)=>{console.log(a.detail)});let a=localStorage.getItem('last_location');if(a){a=JSON.parse(a);new google.maps.LatLng(a.lat,a.lng);this.mapOptions.center.lat=a.lat,this.mapOptions.center.lng=a.lng}}handleLocationPermission(){const a={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},b=(b)=>{'granted'==b.state?this.locationGranted():'prompt'==b.state?navigator.geolocation.getCurrentPosition(()=>{this.locationGranted()},()=>{this.locationDenied()},a):'denied'==b.state&&this.locationDenied()};navigator.permissions?navigator.permissions.query({name:'geolocation'}).then((a)=>{b(a),a.onchange=()=>{window.location.reload()}}):this.locationGranted()}connectedCallback(){super.connectedCallback(),this.handleLocationPermission(),this.user&&gAxios.get(`/users/getlocationbyip`).then(()=>{}),this.loadMapCanvas()}openClearSearch(){this.closeClearFilter(!1);const a=this.shadowRoot.querySelector('#clearSearch');a.classList.add('show')}closeClearSearch(a=!0){const b=this.shadowRoot.querySelector('#clearSearch');b.classList.remove('show'),a&&this.populateJobMarkers(),window.dispatchEvent(new CustomEvent('map:clear_search'))}openClearFilter(){this.closeClearSearch(!1);const a=this.shadowRoot.querySelector('#clearFilter');a.classList.add('show')}closeClearFilter(a=!0){const b=this.shadowRoot.querySelector('#clearFilter');b.classList.remove('show'),a&&this.populateJobMarkers(),window.dispatchEvent(new CustomEvent('map:clear_filter'))}loadMapCanvas(){let a=this.$.mapCanvas,b=this.mapOptions;this.map=new google.maps.Map(a,b),this.map.setOptions({zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}}),window.mobilecheck()&&this.map.setOptions({zoomControl:!1}),this.listenMapEvents(),this.cluster&&window.MarkerClusterer&&(this.markerClusterer=new MarkerClusterer(this.map,[],this.clusterOptions)),window.OverlappingMarkerSpiderfier&&(this.oms=new OverlappingMarkerSpiderfier(this.map,{markersWontMove:!0,markersWontHide:!0,basicFormatEvents:!0}))}locationGranted(){this.getCurrentPosition().then((a)=>a?void this.populateJobMarkers():void this.locationDenied())}locationDenied(){console.log('location denied'),axios.get(`${this.url.API_URL}/getlocationbyip`).then((a)=>{const b={lat:parseFloat(a.data.latitude),lng:parseFloat(a.data.longitude)};this.currentLocation={lat:b.lat,lng:b.lng,latLng:new google.maps.LatLng(b.lat,b.lng)},this.mapOptions.center={lat:b.lat,lng:b.lng},this.populateJobMarkers()})}setMapCenter(){if(!window.localStorage)return;let a=localStorage.getItem('last_location');if(a){a=JSON.parse(a);new google.maps.LatLng(a.lat,a.lng)}}listenMapEvents(){const a=this;this.mapListener('center_changed',function(){if(a.gmap.currentLocation&&a.gmap.map.getBounds()&&(this.map.getBounds().contains(a.gmap.currentLocation.latLng)?window.dispatchEvent(new CustomEvent('map:current_location_in_bounds')):window.dispatchEvent(new CustomEvent('map:current_location_out_bounds'))),!!a.classList.contains('selecting')){let a={lat:this.map.getCenter().lat(),lng:this.map.getCenter().lng(),location:';;;'};window.dispatchEvent(new CustomEvent('map:center_changed',{detail:a}))}})}paintMarkers(a,b=!1){this.removeAllMarkers();let c=null;b&&(c=new google.maps.LatLngBounds);for(var d=0;d<a.length;d++)if(this.newMarker(a[d])&&b){let b=new google.maps.LatLng(a[d].lat,a[d].lng);c.extend(b)}b&&a.length&&this.map.fitBounds(c),this.markerClusterer.repaint()}populateJobMarkers(a=!0){if(this.loadingJobMarkers)return;const b=this;b.markers;b.loadingJobMarkers=!0;let c=axios,d=`${this.url.API_BASE_URL}/job/all?lat=${b.currentLocation.lat}&lng=${b.currentLocation.lng}`;this.auth&&(c=gAxios,d=`/users/job/all?lat=${b.currentLocation.lat}&lng=${b.currentLocation.lng}`);const e=(()=>c.get(d,{headers:{}}).catch(function(){return null}))().then((b)=>!!b&&!!b.data&&(setTimeout(()=>{this.paintMarkers(b.data,a)},200),!0)),f=(()=>'serviceWorker'in navigator&&navigator.serviceWorker.controller?c.get(d,{headers:{Cached:'yes'}}).catch(function(){return null}):Promise.resolve(null))().then((b)=>!!b&&!!b.data&&(this.paintMarkers(b.data,a),!0));e.then((a)=>a||f).then((a)=>{a||(alert('Unable to load the markers'),window.location.href='/'),this.loadingJobMarkers=!1})}_markersChange(a){}newMarker(a){let b=this.markerType.newJob;a.isMyPost=!1,a.isBidded=!1,a.isAwarded=!1,a.hasWinner=!1;let c=[];if(a.bids&&(c=a.bids),this.auth){this.user.id==a.user_id&&(b=this.markerType.myJob,a.fillColor=b.color,a.isMyPost=!0),a.winner&&(a.hasWinner=!0,this.user.id==a.winner.user_id&&(a.isAwarded=!0));for(let d=0;d<c.length;d++)this.user.id==c[d].user_id&&(b=this.markerType.biddedJob,a.fillColor=b.color,a.isBidded=!0)}if(a.hasWinner&&!a.isAwarded&&!a.isMyPost)return!1;const d=this.findBy((b)=>b.lat==a.lat&&b.lng==a.lng);if(d.length){const b=this.offsetMarker(a.lat,a.lng,2);a.lat=b.lat,a.lng=b.lng}return this._newMarker(a),!0}offsetMarker(a,b,c=2){var d=Math.PI;a=+a,b=+b;const e=6378137,f=c,g=f/(e*Math.cos(d*a/180));return{lat:a+180*(f/e)/d,lng:b+180*g/d}}updateMarker(a){if(window.google&&a){var b=new google.maps.LatLng(a.lat,a.lng);const c=this.findBy((b)=>b.id==a.id);c.length?c[0].setPosition(b):this.newMarker(a)}}_newMarker(a){var b='unrelated-marker.svg';a.isMyPost&&(b='related-marker.svg'),a.isBidded&&(b='bidded-marker.svg'),a.isAwarded&&(b='awarded-marker.svg');const c=(a,b)=>`/@${a}/posts/${b}`,d={url:`/assets/images/icons/${b}`};this.addMarker({id:a.id,category:a.category_id,currency:'AED',price:'AED '+a.price,date:a.date,distance:a.distance||null,isBidded:a.isBidded,isMyPost:a.isMyPost,lat:parseFloat(a.lat),lng:parseFloat(a.lng),icon:d,user:a.user,events:[{name:'spider_click',callback:function(){window.dispatchEvent(new CustomEvent('app:title_change',{detail:{title:`${a.name} - The Grid`}})),this.redirect(c(a.user.username,a.id))}}]})}_authChange(){this.map&&this.populateJobMarkers()}_initSocketEvents(){socket.on('user:posted',(a)=>{const b=a;b.isMyPost=!1,this.auth&&b.user.id==this.user.id&&(b.isMyPost=!0),this._newMarker(b)})}}customElements.define(GridMap.is,GridMap);</script></dom-module></body></html>